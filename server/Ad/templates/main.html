{% extends 'base.html' %}
{% load static %}

{% block title %}Орбита Новостей - Главная{% endblock %}

{% block style %}
<style>
    html, body {
        background-color: transparent !important;
        min-height: 100vh;
        margin: 0;
        padding: 0;
        overflow-x: hidden;
        scrollbar-width: thin;
    }
    
    /* Стили для улучшенного звездного фона */
    .enhanced-stars-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
        pointer-events: none;
        overflow: hidden;
    }
    
    /* Базовые стили для звезд */
    .star {
        position: absolute;
        background-color: #fff;
        border-radius: 50%;
        opacity: 0;
        animation: twinkle var(--duration, 4s) ease-in-out infinite;
        animation-delay: var(--delay, 0s);
    }
    
    /* Размеры звезд */
    .star.tiny {
        width: 1px;
        height: 1px;
        box-shadow: 0 0 1px rgba(255, 255, 255, 0.3);
    }
    
    .star.small {
        width: 2px;
        height: 2px;
        box-shadow: 0 0 2px rgba(255, 255, 255, 0.5);
    }
    
    .star.medium {
        width: 3px;
        height: 3px;
        box-shadow: 0 0 3px 1px rgba(255, 255, 255, 0.6);
    }
    
    .star.large {
        width: 4px;
        height: 4px;
        box-shadow: 0 0 4px 2px rgba(255, 255, 255, 0.8);
    }
    
    /* Звезды с особым свечением */
    .star.bright {
        background: radial-gradient(circle, rgba(255, 255, 255, 1) 0%, rgba(255, 255, 255, 0.3) 70%, rgba(255, 255, 255, 0) 100%);
        width: 6px;
        height: 6px;
        box-shadow: 0 0 10px 2px rgba(255, 255, 255, 0.7);
        animation: bright-twinkle var(--duration, 6s) ease-in-out infinite;
        animation-delay: var(--delay, 0s);
    }
    
    /* Падающие звезды (метеоры) */
    .meteor {
        position: absolute;
        width: 2px;
        height: 1px;
        background: linear-gradient(to right, rgba(255, 255, 255, 0), rgba(255, 255, 255, 1) 50%, rgba(255, 255, 255, 0));
        transform: rotate(-35deg);
        opacity: 0;
        top: calc(var(--top, 0.3) * 100%);
        left: calc(var(--left, 0.5) * 100%);
        animation: meteor 8s linear infinite;
        animation-delay: var(--delay, 0s);
        z-index: 1;
    }
    
    /* Туманности */
    .nebula {
        position: absolute;
        width: 150px;
        height: 150px;
        border-radius: 50%;
        background: radial-gradient(ellipse at center, 
                                    rgba(63, 81, 181, 0.05) 0%, 
                                    rgba(76, 0, 153, 0.03) 50%, 
                                    rgba(15, 11, 50, 0) 70%);
        opacity: 0.3;
        animation: pulse 15s ease-in-out infinite;
        animation-delay: var(--delay, 0s);
        transform: scale(var(--scale, 1));
        z-index: 0;
        mix-blend-mode: screen;
    }
    
    /* Анимации */
    @keyframes twinkle {
        0%, 100% { opacity: 0.1; transform: scale(1); }
        50% { opacity: 0.9; transform: scale(1.2); }
    }
    
    @keyframes bright-twinkle {
        0%, 100% { opacity: 0.5; transform: scale(1); filter: blur(0px); }
        25% { opacity: 1; transform: scale(1.1); filter: blur(0px); }
        50% { opacity: 0.7; transform: scale(1.3); filter: blur(1px); }
        75% { opacity: 1; transform: scale(1.1); filter: blur(0px); }
    }
    
    @keyframes meteor {
        0% {
            opacity: 0;
            width: 0;
            transform: translateX(0) translateY(0) rotate(-35deg);
        }
        5% {
            opacity: 1;
            width: 120px;
        }
        20% {
            opacity: 1;
        }
        30% {
            opacity: 0;
            width: 0;
            transform: translateX(900px) translateY(900px) rotate(-35deg);
        }
        100% {
            opacity: 0;
            width: 0;
            transform: translateX(900px) translateY(900px) rotate(-35deg);
        }
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 0.3; transform: scale(var(--scale, 1)); }
        50% { opacity: 0.5; transform: scale(calc(var(--scale, 1) * 1.2)); }
    }
    
    /* Стили для скроллбара body */
    body::-webkit-scrollbar {
        width: 8px;
    }

    body::-webkit-scrollbar-track {
        background: transparent;
    }

    body::-webkit-scrollbar-thumb {
        background-color: rgba(255, 255, 255, 0.3);
        border-radius: 10px;
        border: 2px solid transparent;
    }

    body::-webkit-scrollbar-thumb:hover {
        background-color: rgba(255, 255, 255, 0.5);
    }

    /* Принудительно делаем все контейнеры с прозрачным фоном */
    .container, 
    .content-container,
    .wrapper,
    .page-wrapper,
    .main-wrapper {
        background-color: transparent !important;
    }

    .main-content {
        display: flex;
        justify-content: center;
        align-items: center;
        flex: 1;
        overflow: hidden;
        width: 100%;
        gap: 25px;
        padding: 15px 0;
        background-color: transparent;
        position: relative;
        z-index: 2;
        height: 100vh;
        max-width: 95%;
        margin: 0 auto;
    }

    .news-content, .qr-section {
        align-self: center;
    }

    .news-content {
        background-color: white;
        padding: 20px;
        border-radius: 30px;
        width: 60%;
        flex: 0 0 auto;
        overflow-y: auto;
        box-sizing: border-box;
        font-size: 1.5rem;
        margin: 0;
        scrollbar-width: thin;
        -ms-overflow-style: none;
        max-height: 75vh;
        position: relative;
    }

    /* Настраиваем скроллбар для Chrome, Edge и других браузеров */
    .news-content::-webkit-scrollbar {
        width: 6px;
    }

    .news-content::-webkit-scrollbar-track {
        background: transparent;
    }

    .news-content::-webkit-scrollbar-thumb {
        background-color: rgba(35, 28, 92, 0.5);
        border-radius: 10px;
    }

    .news-content::-webkit-scrollbar-thumb:hover {
        background-color: rgba(35, 28, 92, 0.8);
    }

    .qr-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 30px;
        border-radius: 50px;
        margin: 0;
        width: 30%;
        flex: 0 0 auto;
        transition: all 0.3s ease;
        max-height: 70vh;
    }

    .qr-section:hover {
        transform: translateY(-5px);
    }

    .qr-section img {
        width: 85%;
        height: auto;
        min-width: 200px;
        min-height: 200px;
        max-width: 300px;
        max-height: 300px;
        transition: all 0.3s ease-in-out;
        border-radius: 15px;
        opacity: 1;
        margin-bottom: 15px;
    }

    .qr-section span {
        font-weight: bold;
        font-size: 1.5rem;
        color: white;
        margin-top: 8px;
    }

    .qr-source {
        font-weight: bold;
        font-size: 1.6rem;
        color: #1a237e;
        margin-top: 20px;
        text-align: center;
        transition: all 0.3s ease;
        padding: 10px 20px;
        background-color: rgba(255, 255, 255, 0.95);
        border-radius: 10px;
        border: 1px solid #e0e0e0;
        position: relative;
        display: inline-block;
    }

    .qr-source:hover {
        transform: translateY(-2px);

        color: #3f51b5;
    }

    .qr-source::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        width: 0;
        height: 2px;
        background-color: #3f51b5;
        transition: all 0.3s ease;
        transform: translateX(-50%);
    }

    .qr-source:hover::after {
        width: 80%;
    }

    .news-content h2:first-of-type {
        margin-top: 0;
    }

    .news-content h2 {
        font-size: 2.5rem;
        font-weight: bold;
        margin-top: 0;
        margin-bottom: 15px;
    }

    .news-content p {
        font-size: 1.5rem;
        line-height: 1.6;
    }

    .news-item {
        margin-top: 0;
        position: relative;
    }

    .news-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
    }

    .navigation-buttons {
        display: flex;
        gap: 10px;
    }

    .nav-button {
        background-color: #231c5c;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 8px 15px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background-color 0.3s, transform 0.2s;
    }

    .nav-button:hover {
        background-color: #1a1461;
        transform: translateY(-2px);
    }

    .nav-button:active {
        transform: translateY(0);
    }

    .timer-container {
        position: relative;
        width: 40px;
        height: 40px;
    }

    .timer-svg {
        transform: rotate(-90deg);
        width: 100%;
        height: 100%;
    }

    .timer-circle-bg {
        fill: none;
        stroke: #e6e6e6;
        stroke-width: 3.5;
    }

    .timer-circle-progress {
        fill: none;
        stroke: #231c5c;
        stroke-width: 3.5;
        stroke-linecap: round;
        stroke-dasharray: 125.6;
        stroke-dashoffset: 125.6;
        animation: countdown 20s linear forwards;
    }

    @keyframes countdown {
        from {
            stroke-dashoffset: 125.6;
        }
        to {
            stroke-dashoffset: 0;
        }
    }

    .timer-center {
        position: absolute;
        top: 5px;
        left: 5px;
        width: 30px;
        height: 30px;
        background-color: white;
        border-radius: 50%;
        z-index: 1;
    }

    .news-ratings {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .rating-button {
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        background: none;
        cursor: pointer;
        padding: 5px;
        transition: transform 0.2s, opacity 0.3s;
        opacity: 0.7;
        color: #231c5c;
    }

    .rating-button:hover {
        transform: scale(1.1);
        opacity: 1;
    }

    .rating-button.active {
        opacity: 1;
    }

    .like-button .rating-icon {
        position: relative;
        display: inline-block;
        width: 24px;
        height: 24px;
        vertical-align: middle;
        margin-right: 5px;
    }
    .like-button .rating-icon:before {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        width: 20px;
        height: 20px;
        background: #888888; /* Изменено с зеленого на серый */
        mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M23,10C23,8.89 22.1,8 21,8H14.68L15.64,3.43C15.66,3.33 15.67,3.22 15.67,3.11C15.67,2.7 15.5,2.32 15.23,2.05L14.17,1L7.59,7.58C7.22,7.95 7,8.45 7,9V19A2,2 0 0,0 9,21H18C18.83,21 19.54,20.5 19.84,19.78L22.86,12.73C22.95,12.5 23,12.26 23,12V10M1,21H5V9H1V21Z"/></svg>');
        -webkit-mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M23,10C23,8.89 22.1,8 21,8H14.68L15.64,3.43C15.66,3.33 15.67,3.22 15.67,3.11C15.67,2.7 15.5,2.32 15.23,2.05L14.17,1L7.59,7.58C7.22,7.95 7,8.45 7,9V19A2,2 0 0,0 9,21H18C18.83,21 19.54,20.5 19.84,19.78L22.86,12.73C22.95,12.5 23,12.26 23,12V10M1,21H5V9H1V21Z"/></svg>');
    }

    .dislike-button .rating-icon {
        position: relative;
        display: inline-block;
        width: 24px;
        height: 24px;
        vertical-align: middle;
        margin-right: 5px;
    }
    .dislike-button .rating-icon:before {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        width: 20px;
        height: 20px;
        background: #888888; /* Изменено с красного на серый */
        mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19,15H23V3H19M15,3H6C5.17,3 4.46,3.5 4.16,4.22L1.14,11.27C1.05,11.5 1,11.74 1,12V14A2,2 0 0,0 3,16H9.31L8.36,20.57C8.34,20.67 8.33,20.77 8.33,20.88C8.33,21.3 8.5,21.67 8.77,21.94L9.83,23L16.41,16.41C16.78,16.05 17,15.55 17,15V5C17,3.89 16.1,3 15,3Z"/></svg>');
        -webkit-mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19,15H23V3H19M15,3H6C5.17,3 4.46,3.5 4.16,4.22L1.14,11.27C1.05,11.5 1,11.74 1,12V14A2,2 0 0,0 3,16H9.31L8.36,20.57C8.34,20.67 8.33,20.77 8.33,20.88C8.33,21.3 8.5,21.67 8.77,21.94L9.83,23L16.41,16.41C16.78,16.05 17,15.55 17,15V5C17,3.89 16.1,3 15,3Z"/></svg>');
    }

    .comment-button .rating-icon {
        position: relative;
        display: inline-block;
        width: 24px;
        height: 24px;
        vertical-align: middle;
        margin-right: 5px;
    }
    .comment-button .rating-icon:before {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        width: 20px;
        height: 20px;
        background: #888888; /* Изменено с синего на серый */
        mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9,22A1,1 0 0,1 8,21V18H4A2,2 0 0,1 2,16V4C2,2.89 2.9,2 4,2H20A2,2 0 0,1 22,4V16A2,2 0 0,1 20,18H13.9L10.2,21.71C10,21.9 9.75,22 9.5,22V22H9Z"/></svg>');
        -webkit-mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9,22A1,1 0 0,1 8,21V18H4A2,2 0 0,1 2,16V4C2,2.89 2.9,2 4,2H20A2,2 0 0,1 22,4V16A2,2 0 0,1 20,18H13.9L10.2,21.71C10,21.9 9.75,22 9.5,22V22H9Z"/></svg>');
    }

    .like-button.active .rating-icon:before {
        background: #888888; /* Изменено с зеленого на серый */
    }

    .dislike-button.active .rating-icon:before {
        background: #888888; /* Изменено с красного на серый */
    }

    .rating-count {
        font-size: 0.9rem;
    }

    .background-image {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: -1;
        opacity: 0.5;
    }

    /* Стили для модального окна с комментариями */
    .comments-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(8, 15, 30, 0.85); /* Тёмно-синий оттенок, как звездное небо, но с высокой прозрачностью */
        backdrop-filter: blur(5px); /* Добавляем размытие фона */
    }

    .comments-modal-content {
        position: relative;
        background-color: rgba(255, 255, 255, 0.95);
        margin: 5% auto;
        padding: 20px;
        border-radius: 15px;
        width: 60%;
        max-width: 800px;
        box-shadow: 0 5px 25px rgba(0, 0, 0, 0.4);
        animation: modalopen 0.3s;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    @keyframes modalopen {
        from {opacity: 0; transform: scale(0.9);}
        to {opacity: 1; transform: scale(1);}
    }

    .close-modal {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.3s;
    }

    .close-modal:hover,
    .close-modal:focus {
        color: #231c5c;
        text-decoration: none;
    }

    .comments-header {
        border-bottom: 1px solid #ddd;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }

    .comments-header h3 {
        margin: 0;
        font-size: 1.5rem;
        color: #231c5c;
    }

    .comments-list {
        max-height: 400px;
        overflow-y: auto;
        margin-bottom: 20px;
    }

    .comment-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
    }

    .comment-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
    }

    .comment-username {
        font-weight: bold;
        color: #231c5c;
    }

    .comment-date {
        color: #777;
        font-size: 0.8rem;
    }

    .comment-text {
        margin-bottom: 5px;
    }

    .comment-form {
        display: flex;
        flex-direction: column;
    }

    .comment-textarea {
        width: 100%;
        min-height: 80px;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        resize: vertical;
        font-family: inherit;
    }

    .comment-submit {
        align-self: flex-end;
        background-color: #231c5c;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 8px 15px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .comment-submit:hover {
        background-color: #3949ab;
    }

    .no-comments {
        text-align: center;
        color: #777;
        padding: 20px;
    }

    .error-message {
        color: #f44336;
        margin-bottom: 10px;
    }

    /* Медиа-запросы для отзывчивости */
    @media (max-width: 1200px) {
        .main-content {
            gap: 20px;
            max-width: 95%;
        }
        
        .news-content {
            width: 58%;
            margin: 0;
        }
        
        .qr-section {
            width: 35%;
            margin: 0;
        }
        
        .qr-section img {
            min-width: 180px;
            min-height: 180px;
            max-width: 250px;
            max-height: 250px;
        }
    }

    @media (max-width: 992px) {
        .main-content {
            flex-direction: column;
            align-items: center;
            padding: 10px 0;
        }
        
        .news-content {
            width: 90%;
            max-height: 60vh;
            margin: 0 0 15px 0;
        }
        
        .qr-section {
            width: 50%; /* Увеличиваю ширину для планшетов */
            margin: 0;
            border-radius: 40px;
        }
        
        .qr-section img {
            width: 80%;
            border-radius: 12px;
            min-width: 200px;
            min-height: 200px;
            max-width: 250px;
            max-height: 250px;
        }
        
        .qr-source {
            font-size: 1.5rem;
            padding: 8px 15px;
        }
    }

    @media (max-width: 576px) {
        .main-content {
            padding: 5px 0;
        }
        
        .news-content {
            width: 95%;
            padding: 15px;
            margin: 0 0 10px 0;
        }
        
        .news-content h2 {
            font-size: 2rem;
        }
        
        .news-content p {
            font-size: 1.2rem;
        }
        
        .qr-section {
            width: 70%; /* Увеличиваю ширину для мобильных устройств */
            border-radius: 35px;
            padding: 20px;
            margin: 0;
        }
        
        .qr-source {
            font-size: 1.4rem;
            padding: 8px 15px;
        }
        
        .theme-switcher {
            top: 10px;
            right: 10px;
        }
        
        .theme-icon {
            width: 25px;
            height: 25px;
        }
        
        .theme-menu {
            width: 170px;
            right: -5px;
        }
    }

    /* Стили для переключателя тем */
    .theme-switcher {
        position: absolute;
        top: 12px;
        left: 180px; /* Позиция справа от логотипа RTU MIREA */
        z-index: 1000;
    }
    
    .theme-icon {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid rgba(255, 255, 255, 0.7);
        overflow: hidden;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }
    
    .theme-icon:hover {
        transform: translateY(-2px);
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
    }
    
    /* Стиль для космической темы (по умолчанию) */
    .theme-icon .icon-content {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #1a237e 0%, #4a148c 100%);
    }

    /* Стиль для дождливой темы */
    body.rainy-theme .theme-icon .icon-content {
        background: linear-gradient(135deg, #333333 0%, #666666 100%);
    }
    
    .theme-menu {
        position: absolute;
        top: 40px;
        right: 0;
        background-color: rgba(255, 255, 255, 0.95);
        border-radius: 10px;
        padding: 10px;
        display: none;
        width: 200px;
    }
    
    .theme-menu.visible {
        display: block;
        animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .theme-option {
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        transition: background-color 0.2s;
    }
    
    .theme-option:hover {
        background-color: rgba(35, 28, 92, 0.1);
    }
    
    .theme-option.active {
        background-color: rgba(35, 28, 92, 0.15);
    }
    
    .theme-color {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin-right: 10px;
    }
    
    .cosmic-theme .theme-color {
        background: linear-gradient(135deg, #1a237e 0%, #4a148c 100%);
    }
    
    .rainy-theme .theme-color {
        background: linear-gradient(135deg, #333333 0%, #666666 100%);
    }
    
    /* Стили для дождливого фона с помехами */
    .rainy-background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: -1;
        overflow: hidden;
        background: linear-gradient(to bottom, #333333 0%, #666666 40%, #888888 100%);
    }
    
    .glitch-effect {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0.1;
        background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAACXBIWXMAAAsSAAALEgHS3X78AAAHLUlEQVR4nO2cW49URxCFK1EUCYkfR0RKFCURLxFPkMtDIiRu4i5hYJwZ2GEXGPARPR6PZ4ZZYICxkYA/EGeXVT1n5vTpPqe7q6vrzEgrjQDPdJ9vr6quyzQ9PDw8IgA6O93OYDg6+qUY/5cAdBUCADAzpVRljdWlgMbqC6Ax0B3IGgPIGgPIGgPIGgPIGgPIGgMgaw7Ddo0BkDUHYA0AJfXpzdeL8S89ANLp9tmD51HPD6B6qLPE4E9rDICsMQCyxgDIGgMgawyArDEAssYAyBoDIGsMgKwxALLG6AFI9+jTnY+jnh9A9VBnidnpw93d6HsOoHpoaB3eXPrpLKXU6oY0BmQZZb8S9Q73P7YGNVqQHeyXY2g1uHkDZF1WH7LGAMgaAyBrDICsMQCyxgDIGgMgawyArDEAssZwAaR79PibL6KeH0D1UGeJ2enDw8Poew6gemjIHTnwARNYYwBkjQGQNQZA1hgAWWMAZI0BkDUGQNYYAFlj9ALk+Hj/t81Fuw7gqfwgS75bACl/jffvH2/vPZpzDeCp/CBLvlsAKX+N4+P9nUs99R/AU/lBlny3AFL+GtEgS75bACl/jagoi/qNc4CclypBgkSz3PxOAXK+UlmfIJpUbv5OhMhxAWRfIstI7yKA1aCUUs+/fVLlHF89vB/1/PzVqob6Fm8B5Jzl+fDTnZ9/XVm06wCeyg+y5LsFkPLXMEGgZBXoNYCn8oMs+W4BpPw1TED7dvQGUNlMYI0BkDUGQNYYIx/l9X2EcUoxIMOXLICUL1kAKV+yAFK+ZAGkfMkCSPmSBZDyJQsg5UsWQMqXLICUL1kAKV+yAFK+ZAGkfMkCSPmSBZDyJQsg5UsWQMqXLICUL1kAKV+yCwHpHr269s1gywHU8FRzCZNBz0+/fRP1/ACqh4aWy2KEmTk/P9vaujLYcgA1PNVcwiTfLYCUv4YJpJT65rvJYMsB1PBUcwmTfLcAUv4aJpBbm5tPNjc373U6nSdEtHXr8lzO8TdXv456fmKulQx1ljAJ8cPp6XQymTzZWp3sEtHW5nVbIGbm1o3rUc9PzLWSoc4SJiF+uLM/dHZ2tvbO1/fOOftEdLiy/vvvW5ejnp+YayVDnSVMQvzGzJydna2/vj6ZETM/3Lgc9fzEXCsZ6ixhEuI3gMzMzHFnCZMQvwFkxszZYgmTEL8BZMYgZoROTk5+vHv37sNoYjYDMmOQtZNJKTVrJyGt5MbqnKj9NwVSynvILCMz/8TMS+1O4ixh4uQfFEip7yFzgJyZWZkHDJMgfylApgxS1hvtCc+XUspkhM4SJkH+0oCUVLIaQJ5sbV15dPv244cPflt9+PDhKjNvlFa2mDle1J8NyDwgo5QNBMRl6WxexCgC5Ak5LmES4h81yDwgJVStJpBSSikzM9dXsoL8owWZB6S0kqVT/kL90YBYA+l757FSypo7l5MfNRAXIPPKlta4OkDateuiQFyB3NreWnl2737USZymr7EwEJe7vAv7F3+JOomTufPYNfkCgfiwEotOylWrCZB5QGYMslqhk1LqzbUi35V41wIIIFYgve/yGkCsQUYnpEO9L5CxCmmvDvH6AhmbkLbqEG8IkDEJabMO8YYCGVrIGx+L/W0F3pyVunY9OYQeBjI0IW0dW7nEwKuH7v4SkCG/h7TdIT7r77FCVwHS9/eQxd/2lHc96/JH3RNVC0jfJetWB8isXM8y+v6NddtjLVe/axynO5Qs1zPBVrRc45Cax15Dfme0+VdqhY5dSPsWf63Sk39sQtr3p+aWvQkYi5AOLdcT8bEI6dByzR9jENK+5ZpDxiCkfcs1h7y9OqjBvrXcnN8nhrZXBy32reXWJ75trgYKte/ubn8g5TvIbdVBIfatDpOvnv/QVh0UY986A7lxZ3P7o64OirV3VQe52Luqg1zsXeu4MrNNddCi9l2ZWW2qg8rYu/JH3vauPInZ3pW/9MkfLfauPGF+HdRi78ojNTpMmLfZuzKB9a0O6svezQTWuzqoT3s3HwD2rg7q297NB4C9q4P6tncDMmOQVceUXG/2MYDMGGStNiXXq3201Z4HOTm7lFxv9n2BzFOyvNrHAhkXkDW/lFyP9vGAmJV+6gTWt338QOrP25aS69l+PEDK/9qHvRMQ3ytqoX7aOwPx/f2vhfpp7w4kTcnt3T52yXI93e3dPnaJ8q324/0ecv4uo31sIF2FdMzvIcM/9jJCOubvIXVPe0MpubHah5esRSmksT+GGPaStSiFNPbHEKlAlhXS2B9DpAJZVkhjn/aEn7LanpCmPBMZ+7TH55XKPiGlPBMZe/7iA0h7E1KUZ6Kx5y91y5aPJ0UtkMbOX9JA2puQis5fUr+HtDchFZ+/1N2y5ftJUXRCKt6CmQykjQnJVB1UcgvGdCBtTEim6qCSp71UEW1LSE3VQaVP6dOBtC0hNVUHlT7tpQVpS0Jqqg6qcdxLDdKGhNRUHVTjuJcDpA0Jqa06qMZpLw9I6oTkt5Dt6teTw67qoDKnPZ7n+Rcq+YRKvkl/WAAAAABJRU5ErkJggg==');
        animation: glitch-animation 8s infinite linear;
    }
    
    .glitch-line {
        position: absolute;
        height: 1px;
        width: 100%;
        background-color: rgba(255, 255, 255, 0.4);
        animation: glitch-line 3s infinite;
        z-index: 1;
    }
    
    .glitch-block {
        position: absolute;
        background-color: rgba(255, 255, 255, 0.2);
        animation: glitch-block 2s infinite;
        z-index: 2;
    }
    
    @keyframes glitch-animation {
        0% {
            opacity: 0.1;
            transform: translateX(0) skew(0deg);
        }
        20% {
            opacity: 0.2;
            transform: translateX(5px) skew(2deg);
        }
        40% {
            opacity: 0.1;
            transform: translateX(-5px) skew(-2deg);
        }
        60% {
            opacity: 0.2;
            transform: translateX(0) skew(0deg);
        }
        80% {
            opacity: 0.1;
            transform: translateX(3px) skew(1deg);
        }
        100% {
            opacity: 0.2;
            transform: translateX(-3px) skew(-1deg);
        }
    }
    
    @keyframes glitch-line {
        0% {
            transform: scaleX(0);
            opacity: 0;
        }
        10% {
            transform: scaleX(1);
            opacity: 0.8;
        }
        30% {
            transform: scaleX(1.1);
            opacity: 0.9;
        }
        40% {
            transform: scaleX(1);
            opacity: 0.6;
        }
        100% {
            transform: scaleX(0);
            opacity: 0;
        }
    }
    
    @keyframes glitch-block {
        0% {
            transform: translateX(-100%) translateY(0);
            opacity: 0;
        }
        10% {
            transform: translateX(0) translateY(0);
            opacity: 0.8;
        }
        20% {
            transform: translateX(5px) translateY(0);
            opacity: 0.6;
        }
        30% {
            transform: translateX(-5px) translateY(0);
            opacity: 0.8;
        }
        40% {
            transform: translateX(0) translateY(0);
            opacity: 0.4;
        }
        100% {
            transform: translateX(100%) translateY(0);
            opacity: 0;
        }
    }
    
    .mist {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(to bottom, rgba(50, 50, 50, 0.1) 0%, rgba(90, 90, 90, 0.2) 100%);
        pointer-events: none;
        z-index: 3;
        opacity: 0.2;
    }

    /* Удаляем стили для капель дождя, так как они больше не нужны */
    .raindrop, .splash {
        display: none;
    }
    
    /* Дополнительные стили для дождливой темы */
    body.rainy-theme .news-content {
        background-color: rgba(230, 230, 230, 0.92);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.35);
    }
    
    body.rainy-theme .news-content h2 {
        color: #222222;
    }
    
    body.rainy-theme .news-content p {
        color: #333333;
    }
    
    body.rainy-theme .qr-section {
        background-color: rgba(230, 230, 230, 0.9);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.35);
    }
    
    body.rainy-theme .qr-source {
        color: #222222;
        background-color: rgba(210, 210, 210, 0.95);
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
    }
    
    body.rainy-theme .qr-source:hover {
        color: #444444;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
    
    body.rainy-theme .qr-source:hover::after {
        background-color: #444444;
    }
    
    body.rainy-theme .nav-button {
        background-color: #333333;
    }
    
    body.rainy-theme .nav-button:hover {
        background-color: #555555;
    }
    
    body.rainy-theme .like-button .rating-icon,
    body.rainy-theme .dislike-button .rating-icon,
    body.rainy-theme .comment-button .rating-icon {
        filter: grayscale(100%) brightness(0.8);
    }
    
    body.rainy-theme .timer-circle-progress {
        stroke: #333333;
    }
    
    body.rainy-theme .timer-container {
        opacity: 1;
        visibility: visible;
    }
    
    body.rainy-theme .timer-circle-bg {
        stroke: #cccccc;
    }
    
    body.rainy-theme .timer-center {
        background-color: #cccccc;
    }
    
    body.rainy-theme .news-ratings {
        color: #333333;
    }
    
    body.rainy-theme .news-controls {
        border-top: 1px solid rgba(84, 110, 122, 0.2);
        padding-top: 15px;
        margin-top: 15px;
    }
    
    body.rainy-theme .news-content::-webkit-scrollbar-thumb {
        background-color: rgba(84, 110, 122, 0.5);
    }
    
    body.rainy-theme .news-content::-webkit-scrollbar-thumb:hover {
        background-color: rgba(84, 110, 122, 0.8);
    }
    
    body.rainy-theme body::-webkit-scrollbar-thumb {
        background-color: rgba(84, 110, 122, 0.3);
    }
    
    body.rainy-theme body::-webkit-scrollbar-thumb:hover {
        background-color: rgba(84, 110, 122, 0.5);
    }
    
    body.rainy-theme .comments-modal {
        background-color: rgba(40, 40, 40, 0.85);
    }
    
    body.rainy-theme .comments-modal-content {
        background-color: rgba(220, 220, 220, 0.95);
        box-shadow: 0 5px 25px rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(200, 200, 200, 0.6);
    }
    
    body.rainy-theme .comments-header h3 {
        color: #222222;
    }
    
    body.rainy-theme .comment-username {
        color: #333333;
    }
    
    body.rainy-theme .comment-submit {
        background-color: #333333;
    }
    
    body.rainy-theme .comment-submit:hover {
        background-color: #555555;
    }
    
    body.rainy-theme .close-modal:hover,
    body.rainy-theme .close-modal:focus {
        color: #333333;
    }
    
    body.rainy-theme .comment-textarea {
        border-color: #888888;
    }
    
    body.rainy-theme .comment-textarea:focus {
        border-color: #666666;
        box-shadow: 0 0 5px rgba(80, 80, 80, 0.3);
    }
    
    body.rainy-theme .error-message {
        color: #d55555;
    }
    
    body.rainy-theme .theme-option.active {
        background-color: rgba(50, 50, 50, 0.15);
    }
    
    body.rainy-theme .theme-option:hover {
        background-color: rgba(50, 50, 50, 0.1);
    }

    body.rainy-theme .qr-section {
        background-color: transparent;
        box-shadow: none;
    }

    /* Стили для отображения времени */
    .time-display {
        position: fixed;
        bottom: 8px;
        right: 20px;
        background-color: rgba(255, 255, 255, 0.8);
        padding: 5px 10px;
        border-radius: 15px;
        font-weight: bold;
        color: #231c5c;
        z-index: 101;
    }

    body.rainy-theme .time-display {
        background-color: rgba(200, 200, 200, 0.7);
        color: #222222;
    }

    /* Стили для навигационной панели в дождливой теме */
    body.rainy-theme .header {
        background-color: rgba(40, 40, 40, 0.85);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        border-bottom: 1px solid rgba(80, 80, 80, 0.3);
        z-index: 100;
        position: relative;
    }

    body.rainy-theme .nav-menu {
        z-index: 100;
    }

    body.rainy-theme .nav-link {
        color: rgba(220, 220, 220, 0.9);
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    body.rainy-theme .nav-link:hover {
        color: #ffffff;
        background-color: rgba(80, 80, 80, 0.5);
    }

    body.rainy-theme .header span {
        color: rgba(220, 220, 220, 0.9);
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }
    
    /* Стили для переключателя тем в дождливой теме */
    body.rainy-theme .theme-toggle {
        background: linear-gradient(135deg, #333333, #666666);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.6);
    }
    
    /* Цвет кружка меняется в зависимости от темы */
    .cosmic-theme .theme-circle-toggle {
        background: linear-gradient(135deg, #3b1b78, #1a237e);
    }
    
    .rainy-theme .theme-circle-toggle {
        background: linear-gradient(135deg, #333333, #666666);
    }
    
    .rainy-button {
        background: linear-gradient(135deg, #333333, #666666);
    }

    /* Удаляем стили для капель дождя, так как они больше не нужны */
    .raindrop, .splash {
        display: none;
    }
    
    /* Стили для плавающих квадратов в серой теме */
    .floating-squares {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        z-index: 0; /* Низкий z-index, чтобы не перекрывать важные элементы */
        display: none;
    }
    
    body.rainy-theme .floating-squares {
        display: block;
    }
    
    .square {
        position: absolute;
        display: block;
        list-style: none;
        animation: animate-square 25s linear infinite;
        bottom: -150px;
    }
    
    /* Квадраты разных оттенков серого и белого */
    .square:nth-child(1) {
        left: 25%;
        width: 80px;
        height: 80px;
        animation-delay: 0s;
        background: rgba(255, 255, 255, 0.9); /* Чисто белый */
    }
    
    .square:nth-child(2) {
        left: 10%;
        width: 20px;
        height: 20px;
        animation-delay: 2s;
        animation-duration: 12s;
        background: rgba(0, 0, 0, 0.9); /* Чисто черный */
        border-radius: 20%;
    }
    
    .square:nth-child(3) {
        left: 70%;
        width: 20px;
        height: 20px;
        animation-delay: 4s;
        background: rgba(120, 120, 120, 0.9); /* Средне-серый */
    }
    
    .square:nth-child(4) {
        left: 40%;
        width: 60px;
        height: 60px;
        animation-delay: 0s;
        animation-duration: 18s;
        background: rgba(50, 50, 50, 0.85); /* Темно-серый */
        border-radius: 15%;
    }
    
    .square:nth-child(5) {
        left: 65%;
        width: 20px;
        height: 20px;
        animation-delay: 0s;
        background: rgba(230, 230, 230, 0.95); /* Очень светло-серый */
        border-radius: 50%;
    }
    
    .square:nth-child(6) {
        left: 75%;
        width: 110px;
        height: 110px;
        animation-delay: 3s;
        background: rgba(30, 30, 30, 0.8); /* Темный */
    }
    
    .square:nth-child(7) {
        left: 35%;
        width: 150px;
        height: 150px;
        animation-delay: 7s;
        background: rgba(200, 200, 200, 0.85); /* Светло-серый */
        border-radius: 10%;
    }
    
    .square:nth-child(8) {
        left: 50%;
        width: 25px;
        height: 25px;
        animation-delay: 15s;
        animation-duration: 45s;
        background: rgba(255, 255, 255, 1); /* Белый непрозрачный */
    }
    
    .square:nth-child(9) {
        left: 20%;
        width: 15px;
        height: 15px;
        animation-delay: 2s;
        animation-duration: 35s;
        background: rgba(0, 0, 0, 1); /* Черный непрозрачный */
        border-radius: 40%;
    }
    
    .square:nth-child(10) {
        left: 85%;
        width: 150px;
        height: 150px;
        animation-delay: 0s;
        animation-duration: 11s;
        background: rgba(150, 150, 150, 0.9); /* Выраженный серый */
    }
    
    /* Добавляем больше квадратов с разными оттенками серого */
    .square:nth-child(11) {
        left: 15%;
        width: 90px;
        height: 90px;
        animation-delay: 3.5s;
        animation-duration: 22s;
        background: rgba(70, 70, 70, 0.7); /* Темно-серый полупрозрачный */
        border-radius: 30%;
    }
    
    .square:nth-child(12) {
        left: 60%;
        width: 30px;
        height: 30px;
        animation-delay: 5s;
        animation-duration: 17s;
        background: rgba(240, 240, 240, 1); /* Почти белый */
    }
    
    .square:nth-child(13) {
        left: 5%;
        width: 70px;
        height: 70px;
        animation-delay: 1s;
        animation-duration: 14s;
        background: rgba(20, 20, 20, 0.8); /* Очень темный */
        border-radius: 5%;
    }
    
    .square:nth-child(14) {
        left: 95%;
        width: 18px;
        height: 18px;
        animation-delay: 8s;
        animation-duration: 19s;
        background: rgba(180, 180, 180, 1); /* Средне-светлый непрозрачный */
        border-radius: 25%;
    }
    
    .square:nth-child(15) {
        left: 45%;
        width: 120px;
        height: 120px;
        animation-delay: 0.5s;
        animation-duration: 27s;
        background: rgba(100, 100, 100, 0.75); /* Серый полупрозрачный */
    }
    
    .square:nth-child(16) {
        left: 30%;
        width: 40px;
        height: 40px;
        animation-delay: 6s;
        animation-duration: 16s;
        background: rgba(160, 160, 160, 0.9); /* Средне-серый */
        border-radius: 15%;
    }
    
    .square:nth-child(17) {
        left: 80%;
        width: 55px;
        height: 55px;
        animation-delay: 9s;
        animation-duration: 21s;
        background: rgba(40, 40, 40, 0.95); /* Насыщенный темно-серый */
    }
    
    .square:nth-child(18) {
        left: 22%;
        width: 25px;
        height: 25px;
        animation-delay: 4.5s;
        animation-duration: 23s;
        background: rgba(220, 220, 220, 0.8); /* Светло-серый полупрозрачный */
        border-radius: 40%;
    }
    
    .square:nth-child(19) {
        left: 68%;
        width: 100px;
        height: 100px;
        animation-delay: 7.5s;
        animation-duration: 28s;
        background: rgba(60, 60, 60, 0.85); /* Темно-серый */
        border-radius: 8%;
    }
    
    .square:nth-child(20) {
        left: 92%;
        width: 15px;
        height: 15px;
        animation-delay: 10s;
        animation-duration: 15s;
        background: rgba(250, 250, 250, 1); /* Почти белый непрозрачный */
        border-radius: 20%;
    }
    
    /* Дополнительные квадраты разных оттенков */
    .square:nth-child(21) {
        left: 77%;
        width: 35px;
        height: 35px;
        animation-delay: 1.5s;
        animation-duration: 19s;
        background: rgba(10, 10, 10, 0.9); /* Очень темный непрозрачный */
        border-radius: 12%;
    }
    
    .square:nth-child(22) {
        left: 38%;
        width: 48px;
        height: 48px;
        animation-delay: 6.5s;
        animation-duration: 25s;
        background: rgba(190, 190, 190, 1); /* Светло-серый непрозрачный */
    }
    
    .square:nth-child(23) {
        left: 12%;
        width: 65px;
        height: 65px;
        animation-delay: 8.5s;
        animation-duration: 20s;
        background: rgba(90, 90, 90, 0.95); /* Серый непрозрачный */
        border-radius: 18%;
    }
    
    .square:nth-child(24) {
        left: 88%;
        width: 28px;
        height: 28px;
        animation-delay: 3.2s;
        animation-duration: 22s;
        background: rgba(210, 210, 210, 0.9); /* Светлый полупрозрачный */
        border-radius: 35%;
    }
    
    .square:nth-child(25) {
        left: 52%;
        width: 95px;
        height: 95px;
        animation-delay: 5.8s;
        animation-duration: 26s;
        background: rgba(5, 5, 5, 0.95); /* Почти черный */
    }
    
    .square:nth-child(26) {
        left: 7%;
        width: 32px;
        height: 32px;
        animation-delay: 7.2s;
        animation-duration: 30s;
        background: rgba(225, 225, 225, 1); /* Яркий светло-серый */
        border-radius: 45%;
    }
    
    .square:nth-child(27) {
        left: 73%;
        width: 85px;
        height: 85px;
        animation-delay: 4.7s;
        animation-duration: 18s;
        background: rgba(80, 80, 80, 1); /* Средне-темный непрозрачный */
        border-radius: 6%;
    }
    
    .square:nth-child(28) {
        left: 28%;
        width: 18px;
        height: 18px;
        animation-delay: 9.5s;
        animation-duration: 24s;
        background: rgba(35, 35, 35, 0.8); /* Темный полупрозрачный */
    }
    
    .square:nth-child(29) {
        left: 83%;
        width: 110px;
        height: 110px;
        animation-delay: 2.8s;
        animation-duration: 32s;
        background: rgba(170, 170, 170, 0.95); /* Средне-светлый непрозрачный */
        border-radius: 25%;
    }
    
    .square:nth-child(30) {
        left: 3%;
        width: 22px;
        height: 22px;
        animation-delay: 11.2s;
        animation-duration: 27s;
        background: rgba(245, 245, 245, 0.95); /* Почти белый непрозрачный */
        border-radius: 15%;
    }
    
    /* Добавляем еще 10 квадратов с более экстремальными размерами и оттенками */
    .square:nth-child(31) {
        left: 42%;
        width: 200px;
        height: 200px;
        animation-delay: 12s;
        animation-duration: 35s;
        background: rgba(15, 15, 15, 0.6); /* Темный полупрозрачный */
        border-radius: 5%;
    }
    
    .square:nth-child(32) {
        left: 62%;
        width: 8px;
        height: 8px;
        animation-delay: 4.2s;
        animation-duration: 16s;
        background: rgba(255, 255, 255, 1); /* Белый непрозрачный */
        border-radius: 50%;
    }
    
    .square:nth-child(33) {
        left: 54%;
        width: 130px;
        height: 130px;
        animation-delay: 9.2s;
        animation-duration: 26s;
        background: rgba(110, 110, 110, 0.9); /* Средний серый непрозрачный */
    }
    
    .square:nth-child(34) {
        left: 8%;
        width: 75px;
        height: 75px;
        animation-delay: 14s;
        animation-duration: 31s;
        background: rgba(180, 180, 180, 0.7); /* Светло-серый полупрозрачный */
        border-radius: 10%;
    }
    
    .square:nth-child(35) {
        left: 98%;
        width: 12px;
        height: 12px;
        animation-delay: 6.8s;
        animation-duration: 19s;
        background: rgba(25, 25, 25, 1); /* Темный непрозрачный */
    }
    
    .square:nth-child(36) {
        left: 33%;
        width: 145px;
        height: 145px;
        animation-delay: 8.2s;
        animation-duration: 28s;
        background: rgba(200, 200, 200, 0.85); /* Светлый полупрозрачный */
        border-radius: 3%;
    }
    
    .square:nth-child(37) {
        left: 87%;
        width: 10px;
        height: 10px;
        animation-delay: 15.5s;
        animation-duration: 20s;
        background: rgba(140, 140, 140, 1); /* Средний серый непрозрачный */
        border-radius: 30%;
    }
    
    .square:nth-child(38) {
        left: 17%;
        width: 180px;
        height: 180px;
        animation-delay: 7.5s;
        animation-duration: 40s;
        background: rgba(45, 45, 45, 0.8); /* Темно-серый полупрозрачный */
    }
    
    .square:nth-child(39) {
        left: 78%;
        width: 50px;
        height: 50px;
        animation-delay: 13.2s;
        animation-duration: 23s;
        background: rgba(235, 235, 235, 0.9); /* Светлый непрозрачный */
        border-radius: 15%;
    }
    
    .square:nth-child(40) {
        left: 2%;
        width: 100px;
        height: 100px;
        animation-delay: 10.5s;
        animation-duration: 36s;
        background: rgba(65, 65, 65, 1); /* Темно-серый непрозрачный */
        border-radius: 8%;
    }

    @keyframes animate-square {
        0% {
            transform: translateY(0) rotate(0deg);
            opacity: 0.5;
        }
        
        50% {
            transform: translateY(-500px) rotate(360deg);
            opacity: 0.3;
        }
        
        100% {
            transform: translateY(-1000px) rotate(720deg);
            opacity: 0;
        }
    }
    
    /* Альтернативные анимации для разнообразия */
    .square:nth-child(3n) {
        animation-name: animate-square-alt1;
    }
    
    .square:nth-child(3n+1) {
        animation-name: animate-square-alt2;
    }
    
    @keyframes animate-square-alt1 {
        0% {
            transform: translateY(0) rotate(0deg);
            opacity: 0.5;
        }
        
        33% {
            transform: translateY(-330px) rotate(240deg) translateX(30px);
            opacity: 0.4;
        }
        
        66% {
            transform: translateY(-660px) rotate(480deg) translateX(-30px);
            opacity: 0.2;
        }
        
        100% {
            transform: translateY(-1000px) rotate(720deg);
            opacity: 0;
        }
    }
    
    @keyframes animate-square-alt2 {
        0% {
            transform: translateY(0) rotate(0deg);
            opacity: 0.5;
        }
        
        40% {
            transform: translateY(-400px) rotate(180deg) translateX(-40px);
            opacity: 0.3;
        }
        
        80% {
            transform: translateY(-800px) rotate(540deg) translateX(40px);
            opacity: 0.1;
        }
        
        100% {
            transform: translateY(-1000px) rotate(720deg);
            opacity: 0;
        }
    }
    
    /* Квадраты разных оттенков серого */
    .square:nth-child(1) {
        left: 25%;
        width: 80px;
        height: 80px;
        animation-delay: 0s;
        background: rgba(255, 255, 255, 0.7);
    }
    
    .square:nth-child(2) {
        left: 10%;
        width: 20px;
        height: 20px;
        animation-delay: 2s;
        animation-duration: 12s;
        background: rgba(20, 20, 20, 0.6);
        border-radius: 20%;
    }
    
    .square:nth-child(3) {
        left: 70%;
        width: 20px;
        height: 20px;
        animation-delay: 4s;
        background: rgba(150, 150, 150, 0.6);
    }
    
    .square:nth-child(4) {
        left: 40%;
        width: 60px;
        height: 60px;
        animation-delay: 0s;
        animation-duration: 18s;
        background: rgba(80, 80, 80, 0.5);
        border-radius: 15%;
    }
    
    .square:nth-child(5) {
        left: 65%;
        width: 20px;
        height: 20px;
        animation-delay: 0s;
        background: rgba(220, 220, 220, 0.7);
        border-radius: 50%;
    }
    
    .square:nth-child(6) {
        left: 75%;
        width: 110px;
        height: 110px;
        animation-delay: 3s;
        background: rgba(40, 40, 40, 0.4);
    }
    
    .square:nth-child(7) {
        left: 35%;
        width: 150px;
        height: 150px;
        animation-delay: 7s;
        background: rgba(180, 180, 180, 0.5);
        border-radius: 10%;
    }
    
    .square:nth-child(8) {
        left: 50%;
        width: 25px;
        height: 25px;
        animation-delay: 15s;
        animation-duration: 45s;
        background: rgba(255, 255, 255, 0.8);
    }
    
    .square:nth-child(9) {
        left: 20%;
        width: 15px;
        height: 15px;
        animation-delay: 2s;
        animation-duration: 35s;
        background: rgba(10, 10, 10, 0.7);
        border-radius: 40%;
    }
    
    .square:nth-child(10) {
        left: 85%;
        width: 150px;
        height: 150px;
        animation-delay: 0s;
        animation-duration: 11s;
        background: rgba(130, 130, 130, 0.6);
    }
    
    /* Добавляем больше квадратов с разными оттенками серого */
    .square:nth-child(11) {
        left: 15%;
        width: 90px;
        height: 90px;
        animation-delay: 3.5s;
        animation-duration: 22s;
        background: rgba(60, 60, 60, 0.5);
        border-radius: 30%;
    }
    
    .square:nth-child(12) {
        left: 60%;
        width: 30px;
        height: 30px;
        animation-delay: 5s;
        animation-duration: 17s;
        background: rgba(240, 240, 240, 0.8);
    }
    
    .square:nth-child(13) {
        left: 5%;
        width: 70px;
        height: 70px;
        animation-delay: 1s;
        animation-duration: 14s;
        background: rgba(30, 30, 30, 0.6);
        border-radius: 5%;
    }
    
    .square:nth-child(14) {
        left: 95%;
        width: 18px;
        height: 18px;
        animation-delay: 8s;
        animation-duration: 19s;
        background: rgba(200, 200, 200, 0.7);
        border-radius: 25%;
    }
    
    .square:nth-child(15) {
        left: 45%;
        width: 120px;
        height: 120px;
        animation-delay: 0.5s;
        animation-duration: 27s;
        background: rgba(100, 100, 100, 0.6);
    }
    
    .square:nth-child(16) {
        left: 30%;
        width: 40px;
        height: 40px;
        animation-delay: 6s;
        animation-duration: 16s;
        background: rgba(160, 160, 160, 0.5);
        border-radius: 15%;
    }
    
    .square:nth-child(17) {
        left: 80%;
        width: 55px;
        height: 55px;
        animation-delay: 9s;
        animation-duration: 21s;
        background: rgba(50, 50, 50, 0.7);
    }
    
    .square:nth-child(18) {
        left: 22%;
        width: 25px;
        height: 25px;
        animation-delay: 4.5s;
        animation-duration: 23s;
        background: rgba(220, 220, 220, 0.6);
        border-radius: 40%;
    }
    
    .square:nth-child(19) {
        left: 68%;
        width: 100px;
        height: 100px;
        animation-delay: 7.5s;
        animation-duration: 28s;
        background: rgba(70, 70, 70, 0.5);
        border-radius: 8%;
    }
    
    .square:nth-child(20) {
        left: 92%;
        width: 15px;
        height: 15px;
        animation-delay: 10s;
        animation-duration: 15s;
        background: rgba(250, 250, 250, 0.9);
        border-radius: 20%;
    }
    
    /* Добавляем еще 10 квадратов */
    .square:nth-child(21) {
        left: 77%;
        width: 35px;
        height: 35px;
        animation-delay: 1.5s;
        animation-duration: 19s;
        background: rgba(25, 25, 25, 0.65);
        border-radius: 12%;
    }
    
    .square:nth-child(22) {
        left: 38%;
        width: 48px;
        height: 48px;
        animation-delay: 6.5s;
        animation-duration: 25s;
        background: rgba(190, 190, 190, 0.75);
    }
    
    .square:nth-child(23) {
        left: 12%;
        width: 65px;
        height: 65px;
        animation-delay: 8.5s;
        animation-duration: 20s;
        background: rgba(128, 128, 128, 0.55);
        border-radius: 18%;
    }
    
    .square:nth-child(24) {
        left: 88%;
        width: 28px;
        height: 28px;
        animation-delay: 3.2s;
        animation-duration: 22s;
        background: rgba(210, 210, 210, 0.65);
        border-radius: 35%;
    }
    
    .square:nth-child(25) {
        left: 52%;
        width: 95px;
        height: 95px;
        animation-delay: 5.8s;
        animation-duration: 26s;
        background: rgba(15, 15, 15, 0.7);
    }
    
    .square:nth-child(26) {
        left: 7%;
        width: 32px;
        height: 32px;
        animation-delay: 7.2s;
        animation-duration: 30s;
        background: rgba(230, 230, 230, 0.8);
        border-radius: 45%;
    }
    
    .square:nth-child(27) {
        left: 73%;
        width: 85px;
        height: 85px;
        animation-delay: 4.7s;
        animation-duration: 18s;
        background: rgba(90, 90, 90, 0.6);
        border-radius: 6%;
    }
    
    .square:nth-child(28) {
        left: 28%;
        width: 18px;
        height: 18px;
        animation-delay: 9.5s;
        animation-duration: 24s;
        background: rgba(45, 45, 45, 0.5);
    }
    
    .square:nth-child(29) {
        left: 83%;
        width: 110px;
        height: 110px;
        animation-delay: 2.8s;
        animation-duration: 32s;
        background: rgba(170, 170, 170, 0.55);
        border-radius: 25%;
    }
    
    .square:nth-child(30) {
        left: 3%;
        width: 22px;
        height: 22px;
        animation-delay: 11.2s;
        animation-duration: 27s;
        background: rgba(245, 245, 245, 0.85);
        border-radius: 15%;
    }
    
    /* Добавляем еще 10 квадратов */
    .square:nth-child(31) {
        left: 77%;
        width: 35px;
        height: 35px;
        animation-delay: 1.5s;
        animation-duration: 19s;
        background: rgba(25, 25, 25, 0.65);
        border-radius: 12%;
    }
    
    .square:nth-child(32) {
        left: 38%;
        width: 48px;
        height: 48px;
        animation-delay: 6.5s;
        animation-duration: 25s;
        background: rgba(190, 190, 190, 0.75);
    }
    
    .square:nth-child(33) {
        left: 12%;
        width: 65px;
        height: 65px;
        animation-delay: 8.5s;
        animation-duration: 20s;
        background: rgba(128, 128, 128, 0.55);
        border-radius: 18%;
    }
    
    .square:nth-child(34) {
        left: 88%;
        width: 28px;
        height: 28px;
        animation-delay: 3.2s;
        animation-duration: 22s;
        background: rgba(210, 210, 210, 0.65);
        border-radius: 35%;
    }
    
    .square:nth-child(35) {
        left: 52%;
        width: 95px;
        height: 95px;
        animation-delay: 5.8s;
        animation-duration: 26s;
        background: rgba(15, 15, 15, 0.7);
    }
    
    .square:nth-child(36) {
        left: 7%;
        width: 32px;
        height: 32px;
        animation-delay: 7.2s;
        animation-duration: 30s;
        background: rgba(230, 230, 230, 0.8);
        border-radius: 45%;
    }
    
    .square:nth-child(37) {
        left: 73%;
        width: 85px;
        height: 85px;
        animation-delay: 4.7s;
        animation-duration: 18s;
        background: rgba(90, 90, 90, 0.6);
        border-radius: 6%;
    }
    
    .square:nth-child(38) {
        left: 28%;
        width: 18px;
        height: 18px;
        animation-delay: 9.5s;
        animation-duration: 24s;
        background: rgba(45, 45, 45, 0.5);
    }
    
    .square:nth-child(39) {
        left: 83%;
        width: 110px;
        height: 110px;
        animation-delay: 2.8s;
        animation-duration: 32s;
        background: rgba(170, 170, 170, 0.55);
        border-radius: 25%;
    }
    
    .square:nth-child(40) {
        left: 3%;
        width: 22px;
        height: 22px;
        animation-delay: 11.2s;
        animation-duration: 27s;
        background: rgba(245, 245, 245, 0.85);
        border-radius: 15%;
    }

    @keyframes animate-square {
        0% {
            transform: translateY(0) rotate(0deg);
            opacity: 0.5;
        }
        
        50% {
            transform: translateY(-500px) rotate(360deg);
            opacity: 0.3;
        }
        
        100% {
            transform: translateY(-1000px) rotate(720deg);
            opacity: 0;
        }
    }
    
    /* Альтернативные анимации для разнообразия */
    .square:nth-child(3n) {
        animation-name: animate-square-alt1;
    }
    
    .square:nth-child(3n+1) {
        animation-name: animate-square-alt2;
    }
    
    @keyframes animate-square-alt1 {
        0% {
            transform: translateY(0) rotate(0deg);
            opacity: 0.5;
        }
        
        33% {
            transform: translateY(-330px) rotate(240deg) translateX(30px);
            opacity: 0.4;
        }
        
        66% {
            transform: translateY(-660px) rotate(480deg) translateX(-30px);
            opacity: 0.2;
        }
        
        100% {
            transform: translateY(-1000px) rotate(720deg);
            opacity: 0;
        }
    }
    
    @keyframes animate-square-alt2 {
        0% {
            transform: translateY(0) rotate(0deg);
            opacity: 0.5;
        }
        
        40% {
            transform: translateY(-400px) rotate(180deg) translateX(-40px);
            opacity: 0.3;
        }
        
        80% {
            transform: translateY(-800px) rotate(540deg) translateX(40px);
            opacity: 0.1;
        }
        
        100% {
            transform: translateY(-1000px) rotate(720deg);
            opacity: 0;
        }
    }
    
    /* Квадраты разных оттенков серого */
    .square:nth-child(1) {
        left: 25%;
        width: 80px;
        height: 80px;
        animation-delay: 0s;
        background: rgba(255, 255, 255, 0.7);
    }
    
    .square:nth-child(2) {
        left: 10%;
        width: 20px;
        height: 20px;
        animation-delay: 2s;
        animation-duration: 12s;
        background: rgba(20, 20, 20, 0.6);
        border-radius: 20%;
    }
    
    .square:nth-child(3) {
        left: 70%;
        width: 20px;
        height: 20px;
        animation-delay: 4s;
        background: rgba(150, 150, 150, 0.6);
    }
    
    .square:nth-child(4) {
        left: 40%;
        width: 60px;
        height: 60px;
        animation-delay: 0s;
        animation-duration: 18s;
        background: rgba(80, 80, 80, 0.5);
        border-radius: 15%;
    }
    
    .square:nth-child(5) {
        left: 65%;
        width: 20px;
        height: 20px;
        animation-delay: 0s;
        background: rgba(220, 220, 220, 0.7);
        border-radius: 50%;
    }
    
    .square:nth-child(6) {
        left: 75%;
        width: 110px;
        height: 110px;
        animation-delay: 3s;
        background: rgba(40, 40, 40, 0.4);
    }
    
    .square:nth-child(7) {
        left: 35%;
        width: 150px;
        height: 150px;
        animation-delay: 7s;
        background: rgba(180, 180, 180, 0.5);
        border-radius: 10%;
    }
    
    .square:nth-child(8) {
        left: 50%;
        width: 25px;
        height: 25px;
        animation-delay: 15s;
        animation-duration: 45s;
        background: rgba(255, 255, 255, 0.8);
    }
    
    .square:nth-child(9) {
        left: 20%;
        width: 15px;
        height: 15px;
        animation-delay: 2s;
        animation-duration: 35s;
        background: rgba(10, 10, 10, 0.7);
        border-radius: 40%;
    }
    
    .square:nth-child(10) {
        left: 85%;
        width: 150px;
        height: 150px;
        animation-delay: 0s;
        animation-duration: 11s;
        background: rgba(130, 130, 130, 0.6);
    }
    
    /* Добавляем больше квадратов с разными оттенками серого */
    .square:nth-child(11) {
        left: 15%;
        width: 90px;
        height: 90px;
        animation-delay: 3.5s;
        animation-duration: 22s;
        background: rgba(60, 60, 60, 0.5);
        border-radius: 30%;
    }
    
    .square:nth-child(12) {
        left: 60%;
        width: 30px;
        height: 30px;
        animation-delay: 5s;
        animation-duration: 17s;
        background: rgba(240, 240, 240, 0.8);
    }
    
    .square:nth-child(13) {
        left: 5%;
        width: 70px;
        height: 70px;
        animation-delay: 1s;
        animation-duration: 14s;
        background: rgba(30, 30, 30, 0.6);
        border-radius: 5%;
    }
    
    .square:nth-child(14) {
        left: 95%;
        width: 18px;
        height: 18px;
        animation-delay: 8s;
        animation-duration: 19s;
        background: rgba(200, 200, 200, 0.7);
        border-radius: 25%;
    }
    
    .square:nth-child(15) {
        left: 45%;
        width: 120px;
        height: 120px;
        animation-delay: 0.5s;
        animation-duration: 27s;
        background: rgba(100, 100, 100, 0.6);
    }
    
    .square:nth-child(16) {
        left: 30%;
        width: 40px;
        height: 40px;
        animation-delay: 6s;
        animation-duration: 16s;
        background: rgba(160, 160, 160, 0.5);
        border-radius: 15%;
    }
    
    .square:nth-child(17) {
        left: 80%;
        width: 55px;
        height: 55px;
        animation-delay: 9s;
        animation-duration: 21s;
        background: rgba(50, 50, 50, 0.7);
    }
    
    .square:nth-child(18) {
        left: 22%;
        width: 25px;
        height: 25px;
        animation-delay: 4.5s;
        animation-duration: 23s;
        background: rgba(220, 220, 220, 0.6);
        border-radius: 40%;
    }
    
    .square:nth-child(19) {
        left: 68%;
        width: 100px;
        height: 100px;
        animation-delay: 7.5s;
        animation-duration: 28s;
        background: rgba(70, 70, 70, 0.5);
        border-radius: 8%;
    }
    
    .square:nth-child(20) {
        left: 92%;
        width: 15px;
        height: 15px;
        animation-delay: 10s;
        animation-duration: 15s;
        background: rgba(250, 250, 250, 0.9);
        border-radius: 20%;
    }
    
    /* Добавляем еще 10 квадратов */
    .square:nth-child(21) {
        left: 77%;
        width: 35px;
        height: 35px;
        animation-delay: 1.5s;
        animation-duration: 19s;
        background: rgba(25, 25, 25, 0.65);
        border-radius: 12%;
    }
    
    .square:nth-child(22) {
        left: 38%;
        width: 48px;
        height: 48px;
        animation-delay: 6.5s;
        animation-duration: 25s;
        background: rgba(190, 190, 190, 0.75);
    }
    
    .square:nth-child(23) {
        left: 12%;
        width: 65px;
        height: 65px;
        animation-delay: 8.5s;
        animation-duration: 20s;
        background: rgba(128, 128, 128, 0.55);
        border-radius: 18%;
    }
    
    .square:nth-child(24) {
        left: 88%;
        width: 28px;
        height: 28px;
        animation-delay: 3.2s;
        animation-duration: 22s;
        background: rgba(210, 210, 210, 0.65);
        border-radius: 35%;
    }
    
    .square:nth-child(25) {
        left: 52%;
        width: 95px;
        height: 95px;
        animation-delay: 5.8s;
        animation-duration: 26s;
        background: rgba(15, 15, 15, 0.7);
    }
    
    .square:nth-child(26) {
        left: 7%;
        width: 32px;
        height: 32px;
        animation-delay: 7.2s;
        animation-duration: 30s;
        background: rgba(230, 230, 230, 0.8);
        border-radius: 45%;
    }
    
    .square:nth-child(27) {
        left: 73%;
        width: 85px;
        height: 85px;
        animation-delay: 4.7s;
        animation-duration: 18s;
        background: rgba(90, 90, 90, 0.6);
        border-radius: 6%;
    }
    
    .square:nth-child(28) {
        left: 28%;
        width: 18px;
        height: 18px;
        animation-delay: 9.5s;
        animation-duration: 24s;
        background: rgba(45, 45, 45, 0.5);
    }
    
    .square:nth-child(29) {
        left: 83%;
        width: 110px;
        height: 110px;
        animation-delay: 2.8s;
        animation-duration: 32s;
        background: rgba(170, 170, 170, 0.55);
        border-radius: 25%;
    }
    
    .square:nth-child(30) {
        left: 3%;
        width: 22px;
        height: 22px;
        animation-delay: 11.2s;
        animation-duration: 27s;
        background: rgba(245, 245, 245, 0.85);
        border-radius: 15%;
    }
    
    /* Убеждаемся, что квадраты видны только в серой теме */
    body:not(.rainy-theme):not(.theme-rainy) .floating-squares {
        display: none !important;
    }
    
    body.rainy-theme .floating-squares,
    body.theme-rainy .floating-squares {
        display: block !important;
        z-index: 2;
    }
    
    /* Убеждаемся, что дождливый фон не перекрывает квадраты */
    body.rainy-theme .rainy-background,
    body.theme-rainy .rainy-background {
        z-index: 1;
    }
</style>
{% endblock %}

{% block content %}
<!-- Улучшенный звездный фон -->
<div class="enhanced-stars-container" id="enhanced-stars">
    <!-- Здесь будут динамически созданные звезды и метеоры -->
</div>

<!-- Добавляем контейнер с плавающими квадратами для серой темы -->
<div class="floating-squares" id="floating-squares">
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
    <div class="square"></div>
</div>

<!-- Дождливый фон (изначально скрытый) -->
<div class="rainy-background" id="rainy-background" style="display: none;">
    <div class="mist"></div>
    <!-- Здесь будут динамически созданы капли дождя -->
</div>

<!-- Контейнер для молний -->
<div class="lightning-container" id="lightning-container"></div>

<!-- Элемент для звука грома (скрыт) -->
<audio class="thunder-sound" id="thunder-sound">
    <source src="{% static 'Ad/sounds/thunder.mp3' %}" type="audio/mp3">
</audio>

<!-- Круглое меню выбора тем (скрыто, так как используется в хедере) -->
<div class="theme-circle-menu" id="theme-circle-menu" style="display: none;">
    <div class="theme-circle-toggle" id="theme-circle-toggle">
        <i>⚪️</i>
    </div>
    <div class="theme-circle-menu-items" id="theme-circle-menu-items">
        <div class="theme-option cosmic" data-theme="cosmic">
            <div class="theme-option-icon">✨</div>
            <div class="theme-option-label">Космическая тема</div>
        </div>
        <div class="theme-option rainy" data-theme="rainy">
            <div class="theme-option-icon">🌧️</div>
            <div class="theme-option-label">Дождливая тема</div>
        </div>
    </div>
</div>

<div class="main-content">
    <div class="news-content">
        {% for news in news_list %}
        <div class="news-item" data-index="{{ forloop.counter0 }}" data-id="{{ news.id }}" data-source-url="{% if news.source %}{{ news.source.feed_url }}{% endif %}">
            <h2>{{ news.title }}</h2>
            <p>{{ news.description }}</p>
            <div class="news-controls">
                <div class="news-ratings">
                    <button class="rating-button like-button {% if news.user_rating == 'like' %}active{% endif %}" data-news-id="{{ news.id }}" data-rating="like">
                        <span class="rating-icon"></span>
                        <span class="rating-count">{{ news.likes_count }}</span>
                    </button>
                    <button class="rating-button dislike-button {% if news.user_rating == 'dislike' %}active{% endif %}" data-news-id="{{ news.id }}" data-rating="dislike">
                        <span class="rating-icon"></span>
                        <span class="rating-count">{{ news.dislikes_count }}</span>
                    </button>
                    <button class="rating-button comment-button" data-news-id="{{ news.id }}">
                        <span class="rating-icon"></span>
                        <span class="rating-count">{{ news.comments_count }}</span>
                    </button>
                </div>
                <div class="navigation-buttons">
                    <button class="nav-button back-button" data-index="{{ forloop.counter0 }}">Назад</button>
                    <button class="nav-button skip-button" data-index="{{ forloop.counter0 }}">Пропустить</button>
                </div>
                <div class="timer-container">
                    <svg class="timer-svg" viewBox="0 0 44 44">
                        <circle class="timer-circle-bg" cx="22" cy="22" r="20"></circle>
                        <circle class="timer-circle-progress" cx="22" cy="22" r="20"></circle>
                    </svg>
                    <div class="timer-center"></div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    <div class="qr-section">
        <img id="qr-image" src="{% static 'Ad/images/qr-placeholder.png' %}" alt="QR код">
        <div class="qr-source" id="qr-source">Источник новости</div>
    </div>
</div>

<!-- Модальное окно с комментариями -->
<div id="comments-modal" class="comments-modal">
    <div class="comments-modal-content">
        <span class="close-modal">&times;</span>
        <div class="comments-header">
            <h3>Комментарии</h3>
        </div>
        <div class="comments-list" id="comments-list">
            <!-- Сюда будут добавляться комментарии -->
            <div class="no-comments">
                Комментариев пока нет. Будьте первым!
            </div>
        </div>
        <div class="comment-form" id="comment-form">
            <div class="error-message" id="comment-error" style="display: none;"></div>
            <textarea class="comment-textarea" id="comment-text" placeholder="Напишите комментарий..."></textarea>
            <button class="comment-submit" id="comment-submit">Отправить</button>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
    // Инициализация и обработка всех переключателей тем
    document.addEventListener('DOMContentLoaded', function() {
        console.log('== Инициализация всех переключателей тем ==');
        
        // Проверяем DOM-структуру
        const rainyBackground = document.getElementById('rainy-background');
        const enhancedStars = document.getElementById('enhanced-stars');
        
        console.log('Элементы фона:');
        console.log('- rainy-background:', rainyBackground ? 'найден' : 'НЕ НАЙДЕН');
        console.log('- enhanced-stars:', enhancedStars ? 'найден' : 'НЕ НАЙДЕН');
        
        // Глобальные переменные для использования в других функциях
        window.rainyBackground = rainyBackground;
        window.enhancedStars = enhancedStars;
        
        // *** 1. Инициализация стандартного переключателя тем ***
        const themeToggle = document.getElementById('theme-toggle-button');
        const themeMenu = document.getElementById('theme-menu');
        const themeOptions = document.querySelectorAll('.theme-menu .theme-option');
        
        if (themeToggle && themeMenu) {
            console.log('Стандартное меню тем найдено, добавляем обработчики');
            
            // Обработчик клика по кнопке - открывает/закрывает меню
            themeToggle.addEventListener('click', function(e) {
                e.stopPropagation();
                themeMenu.classList.toggle('visible');
                console.log('Стандартное меню тем переключено');
            });
            
            // Закрытие меню при клике вне его
            document.addEventListener('click', function(e) {
                if (themeMenu.classList.contains('visible') && 
                    !themeMenu.contains(e.target) && 
                    e.target !== themeToggle) {
                    themeMenu.classList.remove('visible');
                    console.log('Стандартное меню тем закрыто (клик вне)');
                }
            });
            
            // Обработчик выбора темы
            themeOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const theme = this.getAttribute('data-theme');
                    console.log(`Выбрана тема (стандартное меню): ${theme}`);
                    applyTheme(theme);
                    themeMenu.classList.remove('visible');
                });
            });
        } else {
            console.warn('Стандартное меню тем не найдено');
        }
        
        // *** 4. Инициализация круглого меню тем ***
        const themeCircleToggle = document.getElementById('theme-circle-toggle');
        const themeCircleMenuItems = document.getElementById('theme-circle-menu-items');
        const circleThemeOptions = document.querySelectorAll('.theme-circle-menu-items .theme-option');
        const themeCircleMenu = document.getElementById('theme-circle-menu');
        
        if (themeCircleToggle && themeCircleMenuItems) {
            console.log('Круглое меню тем найдено, добавляем обработчики');
            
            // === Код для перемещения круглого меню ===
            if (themeCircleMenu) {
                console.log('Добавляем функцию перетаскивания для круглого меню');
                
                // Восстанавливаем сохраненную позицию
                const savedPosition = JSON.parse(localStorage.getItem('themeCirclePosition') || '{}');
                if (savedPosition.bottom !== undefined && savedPosition.right !== undefined) {
                    themeCircleMenu.style.bottom = savedPosition.bottom + 'px';
                    themeCircleMenu.style.right = savedPosition.right + 'px';
                } else if (savedPosition.bottom !== undefined && savedPosition.left !== undefined) {
                    themeCircleMenu.style.bottom = savedPosition.bottom + 'px';
                    themeCircleMenu.style.right = 'auto';
                    themeCircleMenu.style.left = savedPosition.left + 'px';
                } else if (savedPosition.top !== undefined && savedPosition.right !== undefined) {
                    themeCircleMenu.style.top = savedPosition.top + 'px';
                    themeCircleMenu.style.bottom = 'auto';
                    themeCircleMenu.style.right = savedPosition.right + 'px';
                } else if (savedPosition.top !== undefined && savedPosition.left !== undefined) {
                    themeCircleMenu.style.top = savedPosition.top + 'px';
                    themeCircleMenu.style.bottom = 'auto';
                    themeCircleMenu.style.right = 'auto';
                    themeCircleMenu.style.left = savedPosition.left + 'px';
                }
                
                // Переменные для перетаскивания
                let isDragging = false;
                let lastX = 0;
                let lastY = 0;
                let animationFrameId = null;
                
                // Состояние позиции меню
                let menuState = {
                    top: null,
                    left: null,
                    bottom: null,
                    right: null
                };
                
                // Инициализация начального состояния
                function updateMenuState() {
                    const rect = themeCircleMenu.getBoundingClientRect();
                    const isTop = rect.top <= window.innerHeight / 2;
                    const isLeft = rect.left <= window.innerWidth / 2;
                    
                    menuState = {
                        isTop,
                        isLeft,
                        top: isTop ? parseInt(themeCircleMenu.style.top) || rect.top : null,
                        left: isLeft ? parseInt(themeCircleMenu.style.left) || rect.left : null,
                        bottom: !isTop ? parseInt(themeCircleMenu.style.bottom) || (window.innerHeight - rect.bottom) : null,
                        right: !isLeft ? parseInt(themeCircleMenu.style.right) || (window.innerWidth - rect.right) : null
                    };
                }
                
                // Вызываем один раз для начальной инициализации
                updateMenuState();
                
                // Когда пользователь нажимает на меню
                themeCircleToggle.addEventListener('mousedown', function(e) {
                    if (themeCircleMenuItems.classList.contains('active')) {
                        // Если меню открыто, не начинаем перетаскивание
                        return;
                    }
                    
                    isDragging = true;
                    
                    // Запоминаем начальную позицию курсора
                    lastX = e.clientX;
                    lastY = e.clientY;
                    
                    // Обновляем состояние меню
                    updateMenuState();
                    
                    // Запрещаем стандартное поведение при перетаскивании
                    e.preventDefault();
                    
                    // Добавляем класс анимации для визуальной обратной связи
                    themeCircleMenu.classList.add('dragging');
                    
                    // Отменяем предыдущий запрос анимации если он был
                    if (animationFrameId) {
                        cancelAnimationFrame(animationFrameId);
                    }
                });
                
                // Функция для обновления положения меню
                function updateMenuPosition(clientX, clientY) {
                    const deltaX = clientX - lastX;
                    const deltaY = clientY - lastY;
                    
                    lastX = clientX;
                    lastY = clientY;
                    
                    // Обновляем значения в зависимости от привязки
                    if (menuState.isTop) {
                        menuState.top = Math.max(0, menuState.top + deltaY);
                    } else {
                        menuState.bottom = Math.max(0, menuState.bottom - deltaY);
                    }
                    
                    if (menuState.isLeft) {
                        menuState.left = Math.max(0, menuState.left + deltaX);
                    } else {
                        menuState.right = Math.max(0, menuState.right - deltaX);
                    }
                    
                    // Применяем позицию с использованием transform вместо top/right/bottom/left
                    // для большей производительности
                    if (menuState.isTop) {
                        themeCircleMenu.style.top = menuState.top + 'px';
                        themeCircleMenu.style.bottom = 'auto';
                    } else {
                        themeCircleMenu.style.bottom = menuState.bottom + 'px';
                        themeCircleMenu.style.top = 'auto';
                    }
                    
                    if (menuState.isLeft) {
                        themeCircleMenu.style.left = menuState.left + 'px';
                        themeCircleMenu.style.right = 'auto';
                    } else {
                        themeCircleMenu.style.right = menuState.right + 'px';
                        themeCircleMenu.style.left = 'auto';
                    }
                }
                
                // Когда пользователь двигает мышью
                document.addEventListener('mousemove', function(e) {
                    if (!isDragging) return;
                    
                    // Используем requestAnimationFrame для оптимизации производительности
                    if (animationFrameId) {
                        cancelAnimationFrame(animationFrameId);
                    }
                    
                    animationFrameId = requestAnimationFrame(() => {
                        updateMenuPosition(e.clientX, e.clientY);
                });
            });
                
                // Когда пользователь отпускает кнопку мыши
                document.addEventListener('mouseup', function() {
                    if (!isDragging) return;
                    
                    isDragging = false;
                    
                    // Отменяем анимационный фрейм если он активен
                    if (animationFrameId) {
                        cancelAnimationFrame(animationFrameId);
                        animationFrameId = null;
                    }
                    
                    // Удаляем класс анимации
                    themeCircleMenu.classList.remove('dragging');
                    
                    // Сохраняем позицию в localStorage
                    const position = {};
                    
                    if (menuState.isTop) {
                        position.top = menuState.top;
        } else {
                        position.bottom = menuState.bottom;
                    }
                    
                    if (menuState.isLeft) {
                        position.left = menuState.left;
                    } else {
                        position.right = menuState.right;
                    }
                    
                    localStorage.setItem('themeCirclePosition', JSON.stringify(position));
                    console.log('Сохранена позиция меню:', position);
                });
                
                // Добавляем поддержку тач-интерфейса для мобильных устройств
                themeCircleToggle.addEventListener('touchstart', function(e) {
                    if (themeCircleMenuItems.classList.contains('active')) return;
                    
                    isDragging = true;
                    
                    // Запоминаем начальную позицию
                    const touch = e.touches[0];
                    lastX = touch.clientX;
                    lastY = touch.clientY;
                    
                    // Обновляем состояние меню
                    updateMenuState();
                    
                    // Запрещаем стандартное поведение при перетаскивании
                    e.preventDefault();
                    
                    themeCircleMenu.classList.add('dragging');
                    
                    // Отменяем предыдущий запрос анимации если он был
                    if (animationFrameId) {
                        cancelAnimationFrame(animationFrameId);
                    }
                });
                
                document.addEventListener('touchmove', function(e) {
                    if (!isDragging) return;
                    
                    const touch = e.touches[0];
                    
                    // Используем requestAnimationFrame для оптимизации производительности
                    if (animationFrameId) {
                        cancelAnimationFrame(animationFrameId);
                    }
                    
                    animationFrameId = requestAnimationFrame(() => {
                        updateMenuPosition(touch.clientX, touch.clientY);
                    });
                });
                
                document.addEventListener('touchend', function() {
                    if (!isDragging) return;
                    
                    isDragging = false;
                    
                    // Отменяем анимационный фрейм если он активен
                    if (animationFrameId) {
                        cancelAnimationFrame(animationFrameId);
                        animationFrameId = null;
                    }
                    
                    themeCircleMenu.classList.remove('dragging');
                    
                    // Сохраняем позицию в localStorage
                    const position = {};
                    
                    if (menuState.isTop) {
                        position.top = menuState.top;
        } else {
                        position.bottom = menuState.bottom;
                    }
                    
                    if (menuState.isLeft) {
                        position.left = menuState.left;
                    } else {
                        position.right = menuState.right;
                    }
                    
                    localStorage.setItem('themeCirclePosition', JSON.stringify(position));
                    console.log('Сохранена позиция меню (тач):', position);
                });
            }
            
            // Добавляем эффект пульсации
            themeCircleToggle.classList.add('pulse');
            
            // Убираем пульсацию через 5 секунд
            setTimeout(() => {
                themeCircleToggle.classList.remove('pulse');
            }, 5000);
            
            // Обработчик клика по кружку - открывает/закрывает меню
            themeCircleToggle.addEventListener('click', function(e) {
                e.stopPropagation();
                themeCircleMenuItems.classList.toggle('active');
                console.log('Меню тем переключено');
            });
            
            // Закрытие меню при клике вне его
            document.addEventListener('click', function(e) {
                if (themeCircleMenuItems.classList.contains('active') && 
                    !themeCircleMenuItems.contains(e.target) && 
                    e.target !== themeCircleToggle) {
                    themeCircleMenuItems.classList.remove('active');
                    console.log('Меню тем закрыто (клик вне)');
                }
            });
            
            // Обработчик выбора темы
            circleThemeOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const theme = this.getAttribute('data-theme');
                    console.log(`Выбрана тема (круглое меню): ${theme}`);
                    applyTheme(theme);
                    updateActiveThemeOptions(theme);
                    themeCircleMenuItems.classList.remove('active');
                });
            });
        } else {
            console.warn('Круглое меню тем не найдено');
        }
        
        // Применяем сохраненную тему при загрузке
        const savedTheme = localStorage.getItem('theme') || 'cosmic';
        console.log('Загружена тема:', savedTheme);
        applyTheme(savedTheme);
        updateActiveButtons(savedTheme);
        updateActiveThemeOptions(savedTheme);
        
        // Функция применения темы
        function applyTheme(theme) {
            console.log('Основной applyTheme из main.html вызван с темой:', theme);
            
            // Используем глобальную функцию из base.html, если она существует
            if (window.applyTheme !== undefined && typeof window.applyTheme === 'function' && this !== window) {
                console.log('Используем глобальную функцию window.applyTheme');
                window.applyTheme(theme);
                
                // Дополнительные действия для специфичных элементов на этой странице
                const rainyBackground = document.getElementById('rainy-background');
                const enhancedStars = document.getElementById('enhanced-stars');
                
                // Обновляем видимость фонов
                if (enhancedStars && rainyBackground) {
                    if (theme === 'cosmic') {
                        enhancedStars.style.display = 'block';
                        rainyBackground.style.display = 'none';
                        
                        // Удаляем все капли дождя
                        const allDrops = document.querySelectorAll('.raindrop');
                        allDrops.forEach(drop => {
                            if (drop.parentNode) drop.parentNode.removeChild(drop);
                        });
                    } else if (theme === 'rainy') {
                        enhancedStars.style.display = 'none';
                        rainyBackground.style.display = 'block';
                        
                        // Создаем дождливый фон, если его еще нет
                        if (!rainyBackground.querySelector('.raindrop')) {
                            window.createRainyBackgroundGlobal();
                        }
                    }
                }
                return;
            }
            
            // Оригинальная реализация, если глобальная функция недоступна
            console.log('Используем локальную функцию applyTheme');
            
            // Обновляем классы на body для совместимости с новым стилем
            document.body.className = '';
            document.body.classList.add('theme-' + theme);
            
            // Для обратной совместимости добавляем и старые классы
            if (theme === 'cosmic') {
                document.body.classList.add('cosmic-theme');
            } else if (theme === 'rainy') {
                document.body.classList.add('rainy-theme');
            }
            
            // Обновляем видимость фонов
            const rainyBackground = document.getElementById('rainy-background');
            const enhancedStars = document.getElementById('enhanced-stars');
            
            if (enhancedStars && rainyBackground) {
                if (theme === 'cosmic') {
                    enhancedStars.style.display = 'block';
                    rainyBackground.style.display = 'none';
                    
                    // Удаляем все капли дождя
                    const allDrops = document.querySelectorAll('.raindrop');
                    allDrops.forEach(drop => {
                        if (drop.parentNode) drop.parentNode.removeChild(drop);
                    });
                } else if (theme === 'rainy') {
                    enhancedStars.style.display = 'none';
                    rainyBackground.style.display = 'block';
                    
                    // Создаем дождливый фон, если его еще нет
                    if (!rainyBackground.querySelector('.raindrop')) {
                        window.createRainyBackgroundGlobal();
                    }
                }
            }
            
            // Сохраняем выбор в localStorage
            localStorage.setItem('theme', theme);
        }
        
        // Функция обновления активных кнопок
        function updateActiveButtons(theme) {
            // Обновляем простой переключатель
            if (simpleCosmicButton && simpleRainyButton) {
                if (theme === 'cosmic') {
                    simpleCosmicButton.classList.add('active');
                    simpleRainyButton.classList.remove('active');
                } else {
                    simpleCosmicButton.classList.remove('active');
                    simpleRainyButton.classList.add('active');
                }
            }
        }
        
        // Функция обновления активных опций в круглом меню
        function updateActiveThemeOptions(theme) {
            // Обновляем опции в круглом меню
            circleThemeOptions.forEach(option => {
                option.classList.toggle('active', option.getAttribute('data-theme') === theme);
            });
            
            // Обновляем опции в стандартном меню
            themeOptions.forEach(option => {
                option.classList.toggle('active', option.getAttribute('data-theme') === theme);
            });
        }
        
        console.log('== Инициализация всех переключателей тем завершена ==');
    });

    // Создаем улучшенный звездный фон
    document.addEventListener('DOMContentLoaded', () => {
        const enhancedStars = document.getElementById('enhanced-stars');
        if (enhancedStars) {
            // Создаем звезды
            for (let i = 0; i < 200; i++) {
                createStar();
            }
            
            // Создаем метеоры
            setInterval(createMeteor, 10000);
        }
        
        // Функция создания звезды
        function createStar() {
            const star = document.createElement('div');
            star.className = 'enhanced-star';
            
            // Случайный размер
            const size = Math.random() * 3;
            star.style.width = `${size}px`;
            star.style.height = `${size}px`;
            
            // Случайное положение
            star.style.left = `${Math.random() * 100}%`;
            star.style.top = `${Math.random() * 100}%`;
            
            // Случайная яркость и мерцание
            const brightness = Math.random() * 0.8 + 0.2;
            star.style.opacity = brightness;
            star.style.animationDelay = `${Math.random() * 5}s`;
            star.style.animationDuration = `${Math.random() * 3 + 2}s`;
            
            enhancedStars.appendChild(star);
        }
        
        // Функция создания метеора
        function createMeteor() {
            const meteor = document.createElement('div');
            meteor.className = 'meteor';
            
            // Случайное положение сверху и слева
            meteor.style.left = `${Math.random() * 80 + 10}%`;
            meteor.style.top = '0';
            
            // Случайная длина и скорость
            const speed = Math.random() * 2 + 1;
            meteor.style.setProperty('--speed', `${speed}s`);
            
            enhancedStars.appendChild(meteor);
            
            // Удаляем метеор после анимации
            setTimeout(() => {
                if (meteor.parentNode) {
                    meteor.parentNode.removeChild(meteor);
                }
            }, speed * 1000);
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        console.log('== DOMContentLoaded: НАЧАЛО ==');
        
        // Проверка DOM-структуры
        const rainyBackgroundCheck = document.getElementById('rainy-background');
        const enhancedStarsCheck = document.getElementById('enhanced-stars');
        const lightningContainerCheck = document.getElementById('lightning-container');
        
        console.log('Проверка DOM-структуры:');
        console.log('- rainy-background:', rainyBackgroundCheck ? 'найден' : 'НЕ НАЙДЕН');
        console.log('- enhanced-stars:', enhancedStarsCheck ? 'найден' : 'НЕ НАЙДЕН');
        console.log('- lightning-container:', lightningContainerCheck ? 'найден' : 'НЕ НАЙДЕН');
        
        // Предварительная инициализация переменных
        window.rainyBackground = rainyBackgroundCheck;
        window.enhancedStars = enhancedStarsCheck;
        window.lightningContainer = lightningContainerCheck;
        
        // Глобальная функция для создания дождливого фона,
        // чтобы гарантировать доступность во всех частях кода
        window.createRainyBackground = function() {
            console.log('Вызвана глобальная функция createRainyBackground');
            
            const rainyBg = document.getElementById('rainy-background');
            if (!rainyBg) {
                console.error('Элемент rainy-background не найден!');
                return;
            }
            
            // Очищаем возможные остатки предыдущей инициализации
            rainyBg.innerHTML = '<div class="mist"></div>';
            
            // Установка градиентного фона
            rainyBg.style.background = 'linear-gradient(to bottom, #333333 0%, #666666 40%, #888888 100%)';
            
            // Добавляем базовый слой помех
            const glitchEffect = document.createElement('div');
            glitchEffect.className = 'glitch-effect';
            rainyBg.appendChild(glitchEffect);
            
            // Создаем случайные линии помех
            for (let i = 0; i < 12; i++) {
                setTimeout(() => {
                    createGlitchLine(rainyBg);
                }, i * 500);
            }
            
            // Создаем случайные блоки помех
            for (let i = 0; i < 8; i++) {
                setTimeout(() => {
                    createGlitchBlock(rainyBg);
                }, i * 700);
            }
            
            // Постоянное добавление новых элементов помех
            const glitchInterval = setInterval(() => {
                if (document.body.classList.contains('rainy-theme')) {
                    if (Math.random() > 0.5) {
                        createGlitchLine(rainyBg);
                    } else {
                        createGlitchBlock(rainyBg);
                    }
                } else {
                    clearInterval(glitchInterval);
                }
            }, 1000);
        };
        
        function createGlitchLine(container) {
            const line = document.createElement('div');
            line.className = 'glitch-line';
            
            // Случайное положение
            line.style.top = `${Math.random() * 100}%`;
            
            // Случайная скорость анимации
            const duration = 1 + Math.random() * 3;
            line.style.animationDuration = `${duration}s`;
            
            // Случайная задержка начала анимации
            line.style.animationDelay = `${Math.random() * 2}s`;
            
            // Добавляем линию в контейнер
            container.appendChild(line);
            
            // Удаляем линию после анимации
            setTimeout(() => {
                if (line.parentNode) {
                    line.parentNode.removeChild(line);
                }
            }, (duration + parseFloat(line.style.animationDelay)) * 1000);
        }
        
        function createGlitchBlock(container) {
            const block = document.createElement('div');
            block.className = 'glitch-block';
            
            // Случайное положение
            block.style.top = `${Math.random() * 100}%`;
            block.style.left = `${Math.random() * 100}%`;
            
            // Случайный размер
            block.style.width = `${50 + Math.random() * 150}px`;
            block.style.height = `${5 + Math.random() * 30}px`;
            
            // Случайная скорость анимации
            const duration = 1 + Math.random() * 3;
            block.style.animationDuration = `${duration}s`;
            
            // Случайная задержка начала анимации
            block.style.animationDelay = `${Math.random() * 2}s`;
            
            // Добавляем блок в контейнер
            container.appendChild(block);
            
            // Удаляем блок после анимации
            setTimeout(() => {
                if (block.parentNode) {
                    block.parentNode.removeChild(block);
                }
            }, (duration + parseFloat(block.style.animationDelay)) * 1000);
        }
        
        function createRaindrop(container) {
            // Оставляем эту функцию для совместимости, но заменяем ее функционал
            createGlitchLine(container);
        }
        
        console.log('== DOMContentLoaded: ЗАВЕРШЕНО ==');
        
        // Обработчик для большой кнопки переключения на дождливую тему
        const bigRainyButton = document.getElementById('big-rainy-button');
        if (bigRainyButton) {
            console.log('Большая кнопка дождливой темы найдена, добавляем обработчик');
            
            bigRainyButton.addEventListener('click', function() {
                console.log('Нажата БОЛЬШАЯ кнопка дождливой темы');
                
                // Наиболее прямой и надежный способ переключения на дождливую тему
                try {
                    // 1. Устанавливаем класс темы на body
                    document.body.classList.add('rainy-theme');
                    document.body.classList.remove('cosmic-theme');
                    
                    // 2. Находим и показываем дождливый фон
                    const rainyBg = document.getElementById('rainy-background');
                    if (rainyBg) {
                        rainyBg.style.display = 'block';
                        console.log('Дождливый фон показан');
                        
                        // 3. Создаем элементы дождя, если их еще нет
                        if (!rainyBg.querySelector('.raindrop')) {
                            console.log('Генерируем капли дождя');
                            
                            // Создаем элемент тумана, если его нет
                            if (!rainyBg.querySelector('.mist')) {
                                const mist = document.createElement('div');
                                mist.className = 'mist';
                                rainyBg.appendChild(mist);
                            }
                            
                            // Устанавливаем градиентный фон
                            rainyBg.style.background = 'linear-gradient(to bottom, #333333 0%, #666666 40%, #888888 100%)';
                            
                            // Создаем капли дождя
                            for (let i = 0; i < 50; i++) {
                                const drop = document.createElement('div');
                                drop.className = 'raindrop';
                                drop.style.left = `${Math.random() * 100}%`;
                                drop.style.setProperty('--duration', `${0.5 + Math.random() * 1.5}s`);
                                drop.style.setProperty('--delay', `${Math.random() * 2}s`);
                                rainyBg.appendChild(drop);
                            }
                            
                            // Добавляем интервал для постоянного создания капель
                            setInterval(function() {
                                if (document.body.classList.contains('rainy-theme')) {
                                    const drop = document.createElement('div');
                                    drop.className = 'raindrop';
                                    drop.style.left = `${Math.random() * 100}%`;
                                    drop.style.setProperty('--duration', `${0.5 + Math.random() * 1.5}s`);
                                    drop.style.setProperty('--delay', '0s');
                                    rainyBg.appendChild(drop);
                                    
                                    // Удаляем каплю после анимации
                                    setTimeout(() => {
                                        if (drop.parentNode) {
                                            drop.parentNode.removeChild(drop);
                                        }
                                    }, 3000);
                                }
                            }, 100);
                        }
                    } else {
                        console.error('Элемент дождливого фона не найден!');
                    }
                    
                    // 4. Скрываем звездный фон
                    const stars = document.getElementById('enhanced-stars');
                    if (stars) {
                        stars.style.display = 'none';
                        console.log('Звездный фон скрыт');
                    }
                    
                    // 5. Сохраняем выбор в локальное хранилище
                    localStorage.setItem('theme', 'rainy');
                    console.log('Тема сохранена в localStorage');
                    
                    // 6. Обновляем состояние кнопок
                    const simpleRainyBtn = document.getElementById('simple-rainy-button');
                    const simpleCosmicBtn = document.getElementById('simple-cosmic-button');
                    
                    if (simpleRainyBtn) simpleRainyBtn.classList.add('active');
                    if (simpleCosmicBtn) simpleCosmicBtn.classList.remove('active');
                    
                    console.log('Переключение на дождливую тему успешно выполнено!');
                    
                    // Скрываем кнопку
                    bigRainyButton.style.display = 'none';
                } catch (error) {
                    console.error('Ошибка при переключении на дождливую тему:', error);
                }
            });
        } else {
            console.error('Большая кнопка дождливой темы НЕ НАЙДЕНА!');
        }
        
        // Инициализация круглого меню выбора тем
        const themeCircleToggle = document.getElementById('theme-circle-toggle');
        const themeCircleMenuItems = document.getElementById('theme-circle-menu-items');
        const themeOptions = document.querySelectorAll('.theme-option');
        
        if (themeCircleToggle && themeCircleMenuItems) {
            console.log('Круглое меню найдено, добавляем обработчики');
            
            // Добавляем эффект пульсации при загрузке страницы
            themeCircleToggle.classList.add('pulse');
            
            // Убираем пульсацию через 5 секунд
            setTimeout(() => {
                themeCircleToggle.classList.remove('pulse');
            }, 5000);
            
            // Обработчик нажатия на круглую кнопку (открытие/закрытие меню)
            themeCircleToggle.addEventListener('click', function(e) {
                e.stopPropagation(); // Предотвращаем всплытие события
                themeCircleMenuItems.classList.toggle('active');
                console.log('Переключение меню тем');
            });
            
            // Закрытие меню при клике вне его
            document.addEventListener('click', function(e) {
                if (themeCircleMenuItems.classList.contains('active') && 
                    !themeCircleMenuItems.contains(e.target) && 
                    e.target !== themeCircleToggle) {
                    themeCircleMenuItems.classList.remove('active');
                    console.log('Закрытие меню тем (клик вне)');
                }
            });
            
            // Обработчики для элементов меню
            themeOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const theme = this.getAttribute('data-theme');
                    console.log(`Выбрана тема через круглое меню: ${theme}`);
                    
                    // Переключаем тему напрямую
                    if (theme === 'cosmic') {
                        // Космическая тема
                        document.body.classList.remove('rainy-theme');
                        document.body.classList.add('cosmic-theme');
                        
                        const rainyBg = document.getElementById('rainy-background');
                        const enhancedStars = document.getElementById('enhanced-stars');
                        
                        if (rainyBg) rainyBg.style.display = 'none';
                        if (enhancedStars) enhancedStars.style.display = 'block';
                        
                        // Удаляем существующие капли дождя
                        const allDrops = document.querySelectorAll('.raindrop, .flowing-drop');
                        allDrops.forEach(drop => {
                            if (drop.parentNode) drop.parentNode.removeChild(drop);
                        });
                    } else if (theme === 'rainy') {
                        // Дождливая тема
                        document.body.classList.add('rainy-theme');
                        document.body.classList.remove('cosmic-theme');
                        
                        const rainyBg = document.getElementById('rainy-background');
                        const enhancedStars = document.getElementById('enhanced-stars');
                        
                        if (enhancedStars) enhancedStars.style.display = 'none';
                        
                        if (rainyBg) {
                            rainyBg.style.display = 'block';
                            
                            // Создаем дождливый фон, если его еще нет
                            if (!rainyBg.querySelector('.raindrop')) {
                                console.log('Создаем дождливый фон через круглое меню');
                                
                                // Пробуем использовать глобальную функцию
                                if (typeof window.createRainyBackgroundGlobal === 'function') {
                                    window.createRainyBackgroundGlobal();
                                } else {
                                    console.warn('Глобальная функция создания дождя не найдена, используем встроенный метод');
                                    
                                    // Встроенный метод создания дождя
                                    // Очищаем контейнер
                                    rainyBg.innerHTML = '<div class="mist"></div>';
                                    
                                    // Устанавливаем фон
                                    rainyBg.style.background = 'linear-gradient(to bottom, #333333 0%, #666666 40%, #888888 100%)';
                                    
                                    // Создаем туман
                                    const mist = rainyBg.querySelector('.mist');
                                    if (mist) {
                                        mist.style.background = 'linear-gradient(to bottom, rgba(150, 150, 150, 0.1) 0%, rgba(200, 200, 200, 0.2) 100%)';
                                        mist.style.opacity = '0.3';
                                    }
                                    
                                    // Создаем капли
                                    for (let i = 0; i < 50; i++) {
                                        const drop = document.createElement('div');
                                        drop.className = 'raindrop';
                                        drop.style.left = `${Math.random() * 100}%`;
                                        drop.style.setProperty('--duration', `${0.5 + Math.random() * 1.5}s`);
                                        drop.style.setProperty('--delay', `${Math.random() * 2}s`);
                                        rainyBg.appendChild(drop);
                                    }
                                    
                                    // Интервал для постоянного создания капель
                                    const rainInterval = setInterval(() => {
                                        if (document.body.classList.contains('rainy-theme')) {
                                            const drop = document.createElement('div');
                                            drop.className = 'raindrop';
                                            drop.style.left = `${Math.random() * 100}%`;
                                            drop.style.setProperty('--duration', `${0.5 + Math.random() * 1.5}s`);
                                            drop.style.setProperty('--delay', '0s');
                                            rainyBg.appendChild(drop);
                                            
                                            // Удаляем каплю после анимации
                                            setTimeout(() => {
                                                if (drop.parentNode) {
                                                    drop.parentNode.removeChild(drop);
                                                }
                                            }, 3000);
                                        } else {
                                            clearInterval(rainInterval);
                                        }
                                    }, 100);
                                }
                            }
                        } else {
                            console.error('Элемент дождливого фона не найден!');
                        }
                    }
                    
                    // Сохраняем выбор в localStorage
                    localStorage.setItem('theme', theme);
                    
                    // Обновляем другие переключатели тем
                    const simpleCosmicBtn = document.getElementById('simple-cosmic-button');
                    const simpleRainyBtn = document.getElementById('simple-rainy-button');
                    
                    if (theme === 'cosmic') {
                        if (simpleCosmicBtn) simpleCosmicBtn.classList.add('active');
                        if (simpleRainyBtn) simpleRainyBtn.classList.remove('active');
                    } else {
                        if (simpleCosmicBtn) simpleCosmicBtn.classList.remove('active');
                        if (simpleRainyBtn) simpleRainyBtn.classList.add('active');
                    }
                    
                    // Закрываем меню
                    themeCircleMenuItems.classList.remove('active');
                });
            });
            
            // Устанавливаем активную тему в меню
            const currentTheme = localStorage.getItem('theme') || 'cosmic';
            themeOptions.forEach(option => {
                if (option.getAttribute('data-theme') === currentTheme) {
                    option.classList.add('active');
                } else {
                    option.classList.remove('active');
                }
            });
        } else {
            console.error('Круглое меню выбора тем НЕ НАЙДЕНО!');
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        // Создаем улучшенный звездный фон
        function createEnhancedStarryBackground() {
            const container = document.getElementById('enhanced-stars');
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            
            // Добавляем мерцающие звезды разных размеров
            const starTypes = ['tiny', 'small', 'medium', 'large', 'bright'];
            const starCounts = [150, 100, 50, 25, 10]; // Количество звезд каждого типа
            
            starTypes.forEach((type, index) => {
                for (let i = 0; i < starCounts[index]; i++) {
                    const star = document.createElement('div');
                    star.className = `star ${type}`;
                    
                    // Распределяем звезды по экрану
                    star.style.left = `${Math.random() * 100}%`;
                    star.style.top = `${Math.random() * 100}%`;
                    
                    // Назначаем случайные длительности и задержки для анимации
                    const duration = type === 'bright' ? 6 + Math.random() * 6 : 3 + Math.random() * 4;
                    star.style.setProperty('--duration', `${duration}s`);
                    star.style.setProperty('--delay', `${Math.random() * 5}s`);
                    
                    container.appendChild(star);
                }
            });
            
            // Создаем туманности с разными параметрами
            for (let i = 0; i < 4; i++) {
                const nebula = document.createElement('div');
                nebula.className = 'nebula';
                
                // Распределяем туманности по экрану
                nebula.style.left = `${Math.random() * 100}%`;
                nebula.style.top = `${Math.random() * 100}%`;
                
                // Добавляем случайные параметры для анимации
                nebula.style.setProperty('--delay', `${Math.random() * 10}s`);
                nebula.style.setProperty('--scale', `${1 + Math.random() * 1.5}`);
                
                // Случайный поворот для разнообразия
                nebula.style.transform = `scale(var(--scale, 1)) rotate(${Math.random() * 360}deg)`;
                
                container.appendChild(nebula);
            }
            
            // Функция для периодического создания метеоров
            function createMeteor() {
                const meteor = document.createElement('div');
                meteor.className = 'meteor';
                
                // Случайная позиция для начала метеора (в верхней части экрана)
                const topPosition = Math.random() * 0.3; // 0-30% сверху
                const leftPosition = 0.1 + Math.random() * 0.8; // 10-90% слева
                
                meteor.style.setProperty('--top', `${topPosition}`);
                meteor.style.setProperty('--left', `${leftPosition}`);
                
                // Добавляем метеор на страницу
                container.appendChild(meteor);
                
                // Удаляем метеор после завершения анимации
                setTimeout(() => {
                    meteor.remove();
                }, 8000); // Время жизни метеора (должно быть >= времени анимации)
            }
            
            // Изначально создаем несколько метеоров
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    createMeteor();
                }, i * 2000); // Распределяем создание по времени
            }
            
            // Периодически создаем новые метеоры
            setInterval(() => {
                createMeteor();
            }, 8000 + Math.random() * 5000); // Случайный интервал между метеорами
        }
        
        // Вызываем функцию создания звездного фона
        createEnhancedStarryBackground();
        
        // Обеспечиваем прозрачный фон для всех родительских элементов
        function setTransparentBg() {
            // Получаем текущий элемент
            let currentElement = document.querySelector('.main-content');
            
            // Пока не дошли до body, делаем фон родителей прозрачным
            while (currentElement && currentElement.parentElement) {
                currentElement = currentElement.parentElement;
                if (currentElement.tagName !== 'HTML') {
                    currentElement.style.backgroundColor = 'transparent';
                }
            }
        }
        
        // Выполняем при загрузке страницы
        setTransparentBg();
        
        // И также при прокрутке для надежности
        window.addEventListener('scroll', setTransparentBg);
        
        const newsItems = document.querySelectorAll('.news-item');
        const skipButtons = document.querySelectorAll('.skip-button');
        const likeButtons = document.querySelectorAll('.like-button');
        const dislikeButtons = document.querySelectorAll('.dislike-button');
        const backButtons = document.querySelectorAll('.back-button');
        const commentButtons = document.querySelectorAll('.comment-button');
        const commentsModal = document.getElementById('comments-modal');
        const closeModal = document.querySelector('.close-modal');
        const commentsList = document.getElementById('comments-list');
        const commentForm = document.getElementById('comment-form');
        const commentText = document.getElementById('comment-text');
        const commentSubmit = document.getElementById('comment-submit');
        const commentError = document.getElementById('comment-error');
        const qrImage = document.getElementById('qr-image');
        const qrSource = document.getElementById('qr-source');
        
        // Переменные для хранения текущего ID новости в модальном окне
        let currentNewsId = null;
        
        // Карта QR-кодов для разных источников
        const qrCodeSources = {
            'cbr.ru': {
                url: "{% static 'Ad/images/Cbr.png' %}",
                name: "Центральный Банк РФ",
                rainyUrl: "{% static 'Ad/images/cbrfrainy.png' %}"
            },
            'kommersant.ru': {
                url: "{% static 'Ad/images/kommersant.png' %}",
                name: "Коммерсант",
                rainyUrl: "{% static 'Ad/images/kommersantrainy.png' %}"
            },
            'rambler.ru': {
                url: "{% static 'Ad/images/rembler.png' %}",
                name: "Рамблер",
                rainyUrl: "{% static 'Ad/images/ramblerrainy.png' %}"
            }
        };
        
        // Получаем информацию об аутентификации пользователя из шаблона Django
        const userAuthenticated = "{{ user.is_authenticated|yesno:'true,false' }}";
        const loginUrl = "{% url 'login' %}";

        let currentNewsIndex = 0;
        let timer;

        function showNews(index) {
            // Убедимся, что индекс в допустимом диапазоне
            if (index < 0) {
                index = newsItems.length - 1;
            } else if (index >= newsItems.length) {
                index = 0;
            }
            currentNewsIndex = index;

            // Сбрасываем и перезапускаем таймер анимации
            const timerProgressCircles = document.querySelectorAll('.timer-circle-progress');
            timerProgressCircles.forEach(circle => {
                circle.style.animation = 'none';
                circle.offsetHeight;
                circle.style.animation = 'countdown 20s linear forwards';
            });

            // Скрываем все новости и показываем только текущую
            newsItems.forEach((item, i) => {
                item.style.display = (i === index) ? 'block' : 'none';
            });
            
            // Обновляем QR-код в зависимости от источника новости
            updateQRCode(newsItems[index]);
            
            // Обновляем элементы темы
            updateThemeElements();

            // Очищаем предыдущий таймер и устанавливаем новый
            clearTimeout(timer);
            timer = setTimeout(() => {
                showNews((currentNewsIndex + 1) % newsItems.length);
            }, 20000);
        }
        
        // Функция для определения источника новости и обновления QR-кода
        function updateQRCode(newsItem) {
            // Получаем URL источника из атрибута data-source-url
            const sourceUrl = newsItem.dataset.sourceUrl || '';
            
            // По умолчанию ЦБ РФ
            let qrCode = qrCodeSources['cbr.ru'];
            
            // Определяем источник по URL
            if (sourceUrl.includes('cbr.ru') || sourceUrl.includes('centralbank')) {
                qrCode = qrCodeSources['cbr.ru'];
            } else if (sourceUrl.includes('kommersant.ru') || sourceUrl.includes('kommersant')) {
                qrCode = qrCodeSources['kommersant.ru'];
            } else if (sourceUrl.includes('rambler.ru') || sourceUrl.includes('rambler')) {
                qrCode = qrCodeSources['rambler.ru'];
            }
            
            // Проверяем активную тему
            const isRainyTheme = document.body.classList.contains('rainy-theme');
            const imageUrl = isRainyTheme && qrCode.rainyUrl ? qrCode.rainyUrl : qrCode.url;
            
            // Для отладки
            console.log('Источник новости:', sourceUrl);
            console.log('Выбран QR-код для:', qrCode.name);
            console.log('Дождливая тема активна:', isRainyTheme);
            console.log('Путь к изображению QR-кода:', imageUrl);
            
            // Добавляем анимацию fadeout/fadein
            qrSource.style.opacity = '0';
            
            setTimeout(function() {
                // Установка QR-кода
                const qrCodeImage = document.getElementById('qr-image');
                qrCodeImage.src = imageUrl;
                qrCodeImage.alt = qrCode.name;
                
                // Устанавливаем название сайта
                qrSource.textContent = qrCode.name;
                qrSource.style.opacity = '1';
                
                // Добавим обработчики событий для отладки
                qrCodeImage.onload = function() {
                    console.log('QR-код успешно загружен:', imageUrl);
                };
                
                qrCodeImage.onerror = function() {
                    console.error('Ошибка загрузки QR-кода:', imageUrl);
                    console.log('Полный URL после обработки Django:', this.src);
                };
            }, 300);
        }

        // Инициализация показа новостей
        if (newsItems.length > 0) {
            showNews(currentNewsIndex);
        }

        // Добавляем обработчик события изменения темы
        document.addEventListener('themeChanged', function(e) {
            console.log('Получено событие изменения темы, обновляем QR-код...');
            
            // Получаем текущий открытый источник новости
            const currentNewsItem = newsItems[currentNewsIndex];
            const currentSourceUrl = currentNewsItem.source_url;
            
            // Обновляем QR-код в соответствии с новой темой
            updateNewsQRCode(currentSourceUrl);
        });

        // Обработчики для кнопки "Назад"
        backButtons.forEach(button => {
            button.addEventListener('click', () => {
                showNews(currentNewsIndex - 1);

                // AJAX запрос для уведомления сервера
                fetch("/api/skip-news/", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken(),
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({direction: 'back'})
                })
                .then(response => {
                    if (!response.ok) {
                        console.error(`Ошибка при отправке уведомления: ${response.status}`);
                    }
                })
                .catch(error => {
                    console.error('Ошибка при отправке уведомления:', error);
                });
            });
        });

        // Добавляем обработчики для кнопки "Пропустить"
        skipButtons.forEach(button => {
            button.addEventListener('click', () => {
                showNews(currentNewsIndex + 1);

                // AJAX запрос для уведомления сервера
                fetch("/api/skip-news/", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken(),
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({direction: 'forward'})
                })
                .then(response => {
                    if (!response.ok) {
                        console.error(`Ошибка при отправке уведомления: ${response.status}`);
                    }
                })
                .catch(error => {
                    console.error('Ошибка при отправке уведомления:', error);
                });
            });
        });

        // Обработчики событий для кнопок оценки
        function handleRatingClick(button, rating) {
            const newsId = button.dataset.newsId;
            const ratingType = button.dataset.rating;

            // AJAX запрос для отправки оценки
            fetch("/api/rate-news/", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken(),
                    'Accept': 'application/json' // Явно указываем, что ожидаем JSON
                },
                body: JSON.stringify({
                    news_id: newsId,
                    rating_type: ratingType
                })
            })
            .then(response => {
                if (!response.ok) {
                    console.error(`HTTP ошибка! Статус: ${response.status}`);
                    return response.text().then(text => {
                        console.error("Содержимое ответа:", text);
                        throw new Error(`HTTP ошибка! Статус: ${response.status}`);
                    });
                }
                
                // Проверка типа содержимого на валидность JSON
                const contentType = response.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    return response.text().then(text => {
                        console.error("Неверный тип содержимого:", contentType);
                        console.error("Содержимое ответа:", text);
                        throw new Error(`Неожиданный тип содержимого: ${contentType}`);
                    });
                }
                
                return response.json();
            })
            .then(data => {
                console.log("Успешный ответ:", data);
                if (data.status === 'success' || data.status === 'removed') {
                    // Обновляем счетчики лайков и дизлайков
                    const newsItem = document.querySelector(`.news-item[data-id="${newsId}"]`);
                    const likeButton = newsItem.querySelector('.like-button');
                    const dislikeButton = newsItem.querySelector('.dislike-button');

                    likeButton.querySelector('.rating-count').textContent = data.likes;
                    dislikeButton.querySelector('.rating-count').textContent = data.dislikes;

                    // Обновляем активный класс кнопок
                    if (data.status === 'success') {
                        if (ratingType === 'like') {
                            likeButton.classList.add('active');
                            dislikeButton.classList.remove('active');
                        } else {
                            dislikeButton.classList.add('active');
                            likeButton.classList.remove('active');
                        }
                    } else {
                        // Если оценка была удалена
                        button.classList.remove('active');
                    }
                } else if (data.status === 'error') {
                    console.error('Ошибка:', data.message);
                    alert(`Ошибка при оценке новости: ${data.message}`);
                }
            })
            .catch(error => {
                console.error('Ошибка при обработке запроса:', error);
                alert('Произошла ошибка при отправке оценки. Пожалуйста, попробуйте еще раз.');
            });
        }

        // Функция для проверки авторизации и вызова соответствующего действия
        function handleRatingButtonClick(button, ratingType) {
            if (userAuthenticated === "true") {
                handleRatingClick(button, ratingType);
            } else {
                alert('Пожалуйста, войдите в систему, чтобы оценивать новости.');
                window.location.href = loginUrl;
            }
        }

        // Обработчик для кнопок лайков
        likeButtons.forEach(button => {
            button.addEventListener('click', () => handleRatingButtonClick(button, 'like'));
        });

        // Обработчик для кнопок дизлайков
        dislikeButtons.forEach(button => {
            button.addEventListener('click', () => handleRatingButtonClick(button, 'dislike'));
        });
        
        // Функция для загрузки комментариев к новости
        function loadComments(newsId) {
            commentsList.innerHTML = '<div class="no-comments">Загрузка комментариев...</div>';
            
            fetch(`/api/comments/${newsId}/`, {
                headers: {
                    'Accept': 'application/json' // Явно указываем, что ожидаем JSON
                }
            })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            console.error(`HTTP ошибка! Статус: ${response.status}`);
                            console.error("Содержимое ответа:", text);
                            throw new Error(`HTTP ошибка! Статус: ${response.status}`);
                        });
                    }
                    
                    // Проверка типа содержимого на валидность JSON
                    const contentType = response.headers.get("content-type");
                    if (!contentType || !contentType.includes("application/json")) {
                        return response.text().then(text => {
                            console.error("Неверный тип содержимого:", contentType);
                            console.error("Содержимое ответа:", text);
                            throw new Error(`Неожиданный тип содержимого: ${contentType}`);
                        });
                    }
                    
                    return response.json();
                })
                .then(data => {
                    console.log("Ответ от API комментариев:", data);
                    if (data.status === 'success') {
                        const comments = data.comments;
                        
                        if (comments.length === 0) {
                            commentsList.innerHTML = '<div class="no-comments">Комментариев пока нет. Будьте первым!</div>';
                        } else {
                            commentsList.innerHTML = '';
                            comments.forEach(comment => {
                                const commentItem = document.createElement('div');
                                commentItem.className = 'comment-item';
                                commentItem.innerHTML = `
                                    <div class="comment-header">
                                        <span class="comment-username">${comment.username}</span>
                                        <span class="comment-date">${comment.created_at}</span>
                                    </div>
                                    <div class="comment-text">${comment.text}</div>
                                `;
                                commentsList.appendChild(commentItem);
                            });
                        }
                    } else {
                        commentsList.innerHTML = `<div class="error-message">Ошибка загрузки комментариев: ${data.message}</div>`;
                    }
                })
                .catch(error => {
                    console.error('Ошибка при загрузке комментариев:', error);
                    commentsList.innerHTML = '<div class="error-message">Ошибка при загрузке комментариев. Пожалуйста, попробуйте позже.</div>';
                });
        }
        
        // Функция для добавления нового комментария
        function addComment(newsId, commentText) {
            if (!commentText.trim()) {
                commentError.textContent = 'Пожалуйста, введите текст комментария';
                commentError.style.display = 'block';
                return;
            }
            
            commentError.style.display = 'none';
            commentSubmit.disabled = true;
            
            fetch('/api/add-comment/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken(),
                    'Accept': 'application/json' // Явно указываем, что ожидаем JSON
                },
                body: JSON.stringify({
                    news_id: newsId,
                    comment_text: commentText
                })
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('Пожалуйста, войдите в систему, чтобы оставлять комментарии.');
                    }
                    
                    return response.text().then(text => {
                        console.error(`HTTP ошибка! Статус: ${response.status}`);
                        console.error("Содержимое ответа:", text);
                        throw new Error(`HTTP ошибка! Статус: ${response.status}`);
                    });
                }
                
                // Проверка типа содержимого на валидность JSON
                const contentType = response.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    return response.text().then(text => {
                        console.error("Неверный тип содержимого:", contentType);
                        console.error("Содержимое ответа:", text);
                        throw new Error(`Неожиданный тип содержимого: ${contentType}`);
                    });
                }
                
                return response.json();
            })
            .then(data => {
                console.log("Ответ от API добавления комментария:", data);
                if (data.status === 'success') {
                    // Очищаем форму
                    commentText.value = '';
                    
                    // Если это первый комментарий, очищаем сообщение "нет комментариев"
                    const noComments = commentsList.querySelector('.no-comments');
                    if (noComments) {
                        commentsList.innerHTML = '';
                    }
                    
                    // Добавляем новый комментарий в начало списка
                    const commentItem = document.createElement('div');
                    commentItem.className = 'comment-item';
                    commentItem.innerHTML = `
                        <div class="comment-header">
                            <span class="comment-username">${data.comment.username}</span>
                            <span class="comment-date">${data.comment.created_at}</span>
                        </div>
                        <div class="comment-text">${data.comment.text}</div>
                    `;
                    commentsList.insertBefore(commentItem, commentsList.firstChild);
                    
                    // Обновляем счетчик комментариев на кнопке
                    const commentButton = document.querySelector(`.comment-button[data-news-id="${newsId}"]`);
                    const countElement = commentButton.querySelector('.rating-count');
                    const currentCount = parseInt(countElement.textContent) || 0;
                    countElement.textContent = currentCount + 1;
                    
                    // Закрываем модальное окно
                    commentsModal.style.display = 'none';
                } else {
                    commentError.textContent = data.message;
                    commentError.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Ошибка при добавлении комментария:', error);
                commentError.textContent = error.message;
                commentError.style.display = 'block';
            })
            .finally(() => {
                commentSubmit.disabled = false;
            });
        }
        
        // Обработчики для комментариев
        commentButtons.forEach(button => {
            button.addEventListener('click', () => {
                const newsId = button.dataset.newsId;
                currentNewsId = newsId;
                
                // Очищаем предыдущие данные
                commentText.value = '';
                commentError.style.display = 'none';
                
                // Проверяем авторизацию для формы комментариев
                if (userAuthenticated !== "true") {
                    commentForm.innerHTML = `
                        <div class="error-message">
                            Пожалуйста, <a href="${loginUrl}">войдите в систему</a>, чтобы оставлять комментарии.
                        </div>
                    `;
                } else {
                    // Восстанавливаем форму если она была изменена
                    if (!commentText) {
                        commentForm.innerHTML = `
                            <div class="error-message" id="comment-error" style="display: none;"></div>
                            <textarea class="comment-textarea" id="comment-text" placeholder="Напишите комментарий..."></textarea>
                            <button class="comment-submit" id="comment-submit">Отправить</button>
                        `;
                        commentText = document.getElementById('comment-text');
                        commentSubmit = document.getElementById('comment-submit');
                        commentError = document.getElementById('comment-error');
                    }
                }
                
                // Загружаем комментарии
                loadComments(newsId);
                
                // Открываем модальное окно
                commentsModal.style.display = 'block';
            });
        });
        
        // Обработчик для отправки комментария
        commentSubmit.addEventListener('click', () => {
            if (currentNewsId) {
                addComment(currentNewsId, commentText.value);
            }
        });
        
        // Обработчик для закрытия модального окна
        closeModal.addEventListener('click', () => {
            commentsModal.style.display = 'none';
        });
        
        // Закрытие модального окна при клике вне его области
        window.addEventListener('click', (event) => {
            if (event.target === commentsModal) {
                commentsModal.style.display = 'none';
            }
        });

        // Функция для получения CSRF токена
        function getCsrfToken() {
            return document.cookie
                .split('; ')
                .find(row => row.startsWith('csrftoken='))
                ?.split('=')[1];
        }
        
        // ===== НОВЫЙ КОД ДЛЯ УПРАВЛЕНИЯ ТЕМАМИ =====
        
        // Переключатель тем
        const themeToggle = document.getElementById('theme-toggle-button');
        const themeMenu = document.getElementById('theme-menu');
        const themeOptions = document.querySelectorAll('.theme-menu .theme-option');
        const rainyBackground = document.getElementById('rainy-background');
        const enhancedStars = document.getElementById('enhanced-stars');
        
        // Получаем прямые ссылки на опции тем
        const cosmicThemeOption = document.querySelector('.theme-option.cosmic-theme');
        const rainyThemeOption = document.querySelector('.theme-option.rainy-theme');
        
        // Проверяем сохраненную тему при загрузке страницы
        const savedTheme = localStorage.getItem('theme') || 'cosmic';
        setTheme(savedTheme);
        
        // Проверка наличия элементов в DOM
        console.log('Проверка наличия элементов в DOM:');
        console.log('- themeToggle:', themeToggle ? 'найден' : 'НЕ НАЙДЕН');
        console.log('- themeMenu:', themeMenu ? 'найден' : 'НЕ НАЙДЕН');
        console.log('- cosmicThemeOption:', cosmicThemeOption ? 'найден' : 'НЕ НАЙДЕН');
        console.log('- rainyThemeOption:', rainyThemeOption ? 'найден' : 'НЕ НАЙДЕН');
        console.log('- rainyBackground:', rainyBackground ? 'найден' : 'НЕ НАЙДЕН');
        console.log('- enhancedStars:', enhancedStars ? 'найден' : 'НЕ НАЙДЕН');
        
        // Показываем/скрываем меню тем при клике на иконку
        themeToggle.addEventListener('click', () => {
            console.log('Клик по переключателю тем');
            themeMenu.classList.toggle('visible');
            console.log('Меню тем видимо:', themeMenu.classList.contains('visible'));
        });
        
        // Аварийное восстановление космической темы при двойном клике
        themeToggle.addEventListener('dblclick', () => {
            // Принудительно устанавливаем космическую тему
            document.body.classList.remove('rainy-theme');
            rainyBackground.style.display = 'none';
            enhancedStars.style.display = 'block';
            localStorage.setItem('theme', 'cosmic');
            
            // Удаляем все капли при переключении на космическую тему
            removeAllDrops();
            
            // Обновляем активную опцию в меню
            themeOptions.forEach(option => {
                if (option.dataset.theme === 'cosmic') {
                    option.classList.add('active');
                } else {
                    option.classList.remove('active');
                }
            });
            
            // Обновляем элементы интерфейса
            updateThemeElements();
            
            // Закрываем меню если открыто
            themeMenu.classList.remove('visible');
            
            console.log('АВАРИЙНЫЙ СБРОС: восстановлена космическая тема');
        });
        
        // Закрываем меню при клике вне его
        document.addEventListener('click', (event) => {
            if (!themeToggle.contains(event.target) && !themeMenu.contains(event.target)) {
                themeMenu.classList.remove('visible');
            }
        });
        
        // Прямые обработчики для выбора тем
        cosmicThemeOption.addEventListener('click', () => {
            console.log('Клик на космическую тему');
            setTheme('cosmic');
            themeMenu.classList.remove('visible');
        });
        
        rainyThemeOption.addEventListener('click', () => {
            console.log('Клик на дождливую тему');
            try {
            setTheme('rainy');
                console.log('Тема успешно изменена на дождливую');
            } catch (error) {
                console.error('Ошибка при переключении на дождливую тему:', error);
            }
            themeMenu.classList.remove('visible');
        });
        
        // Общий обработчик (на всякий случай)
        themeOptions.forEach(option => {
            option.addEventListener('click', () => {
                const theme = option.dataset.theme;
                setTheme(theme);
                themeMenu.classList.remove('visible');
            });
        });
        
        // Функция для установки темы
        function setTheme(theme) {
            console.log('Вызов setTheme с параметром:', theme);
            
            // Обновляем простые кнопки тоже
            try {
                const simpleCosmicBtn = document.getElementById('simple-cosmic-button');
                const simpleRainyBtn = document.getElementById('simple-rainy-button');
                
                if (theme === 'cosmic' && simpleCosmicBtn && simpleRainyBtn) {
                    simpleCosmicBtn.classList.add('active');
                    simpleRainyBtn.classList.remove('active');
                } else if (theme === 'rainy' && simpleCosmicBtn && simpleRainyBtn) {
                    simpleRainyBtn.classList.add('active');
                    simpleCosmicBtn.classList.remove('active');
                }
            } catch (error) {
                console.error('Ошибка при обновлении простых кнопок:', error);
            }
            
            // Проверяем существование элементов
            if (!rainyBackground) {
                console.error('Ошибка: элемент rainyBackground не найден!');
                rainyBackground = document.getElementById('rainy-background');
                if (!rainyBackground) {
                    console.error('Не удалось найти элемент с id="rainy-background"');
                    return;
                }
            }
            
            if (!enhancedStars) {
                console.error('Ошибка: элемент enhancedStars не найден!');
                enhancedStars = document.getElementById('enhanced-stars');
                if (!enhancedStars) {
                    console.error('Не удалось найти элемент с id="enhanced-stars"');
                    return;
                }
            }
            
            // Сохраняем выбор пользователя
            localStorage.setItem('theme', theme);
            
            // Обновляем активную опцию в меню
            themeOptions.forEach(option => {
                if (option.dataset.theme === theme) {
                    option.classList.add('active');
                } else {
                    option.classList.remove('active');
                }
            });
            
            // Определяем функцию removeAllDrops если она еще не определена глобально
            if (typeof window.removeAllDrops !== 'function') {
                window.removeAllDrops = function() {
                    console.log('Удаление всех капель...');
                    // Удаляем все flowing-drop
                    const allFlowingDrops = document.querySelectorAll('.flowing-drop');
                    allFlowingDrops.forEach(drop => {
                        if (drop.parentNode) {
                            drop.parentNode.removeChild(drop);
                        }
                    });
                };
            }
            
            // Удаляем все капли при переключении темы
            try {
                window.removeAllDrops();
            } catch (error) {
                console.error('Ошибка при удалении капель:', error);
            }
            
            // Останавливаем интервал молний если он активен
            if (lightningInterval) {
                clearInterval(lightningInterval);
            }
            
            // Применяем тему к body
            if (theme === 'rainy') {
                console.log('Применяем дождливую тему через глобальную функцию setRainyTheme');
                // Используем нашу новую функцию для установки дождливой темы
                window.setRainyTheme();
                
                // Запускаем эффект молний, если он нужен
                try {
                    if (typeof startLightningEffects === 'function') {
                        console.log('Запускаем эффект молний');
                        startLightningEffects();
                    } else {
                        console.error('Функция startLightningEffects не определена');
                    }
                } catch (error) {
                    console.error('Ошибка при запуске эффекта молний:', error);
                }
            } else {
                console.log('Применяем космическую тему...');
                // Космическая тема (по умолчанию)
                document.body.classList.remove('rainy-theme');
                document.body.classList.add('cosmic-theme');
                
                if (rainyBackground) {
                rainyBackground.style.display = 'none';
                }
                
                if (enhancedStars) {
                enhancedStars.style.display = 'block';
                }
            }
            
            // Принудительно обновляем видимость элементов
            updateThemeElements();
            
            console.log('Тема изменена на:', theme);
        }
        
        // Дополнительная функция для обновления элементов при смене темы
        function updateThemeElements() {
            const newsItems = document.querySelectorAll('.news-item');
            const timers = document.querySelectorAll('.timer-container');
            const newsControls = document.querySelectorAll('.news-controls');
            const floatingSquares = document.getElementById('floating-squares');
            
            // Убедимся что все таймеры видимы
            timers.forEach(timer => {
                timer.style.opacity = '1';
                timer.style.visibility = 'visible';
            });
            
            // Убедимся, что все элементы управления видимы
            newsControls.forEach(control => {
                control.style.opacity = '1';
                control.style.visibility = 'visible';
            });
            
            // Убедимся, что текущая новость отображается корректно
            if (newsItems.length > 0 && currentNewsIndex < newsItems.length) {
                newsItems[currentNewsIndex].style.display = 'block';
            }
            
            // Управляем видимостью плавающих квадратов
            if (floatingSquares) {
                if (document.body.classList.contains('rainy-theme') || document.body.classList.contains('theme-rainy')) {
                    floatingSquares.style.display = 'block';
                    // Убеждаемся, что плавающие квадраты имеют высокий z-index
                    floatingSquares.style.zIndex = '2';
                    console.log('Плавающие квадраты активированы в серой теме');
                } else {
                    floatingSquares.style.display = 'none';
                    console.log('Плавающие квадраты скрыты для не-серой темы');
                }
            } else {
                console.error('Не удалось найти контейнер с плавающими квадратами!');
            }
            
            // Обновим прозрачность QR-секции в зависимости от темы
            const qrSection = document.querySelector('.qr-section');
            if (qrSection) {
                if (document.body.classList.contains('rainy-theme')) {
                    qrSection.style.backgroundColor = 'transparent';
                    qrSection.style.backdropFilter = 'none';
                    qrSection.style.boxShadow = 'none';
                } else {
                    // Восстановление стилей для космической темы
                    qrSection.style.backgroundColor = '';
                    qrSection.style.backdropFilter = '';
                    qrSection.style.boxShadow = '';
                }
            }
        }
        
        // Функция для создания дождливого фона - теперь использует глитч-эффект
        function createRainyBackground() {
            console.log('Локальная функция createRainyBackground вызывает глобальную функцию createRainyBackgroundGlobal');
            
            // Удаляем капли дождя, которые могли остаться
            removeAllDrops();
            
            // Используем нашу новую функцию для создания глитч-эффекта
            if (typeof window.createRainyBackgroundGlobal === 'function') {
                window.createRainyBackgroundGlobal();
                } else {
                console.error('Глобальная функция createRainyBackgroundGlobal не определена');
                
                // Запасной вариант, если глобальная функция не найдена
                const container = rainyBackground;
                if (container) {
                    // Меняем фон на темно-серый градиент
                    container.style.background = 'linear-gradient(to bottom, #333333 0%, #666666 40%, #888888 100%)';
                    
                    // Добавляем туман
                    const mist = container.querySelector('.mist') || document.createElement('div');
                    mist.className = 'mist';
                    mist.style.background = 'linear-gradient(to bottom, rgba(50, 50, 50, 0.1) 0%, rgba(90, 90, 90, 0.2) 100%)';
                    mist.style.opacity = '0.2';
                    
                    if (!mist.parentNode) {
                        container.appendChild(mist);
                    }
                }
            }
        }
        
        // Добавим прямой обработчик при загрузке страницы для дополнительной надежности
        try {
            const directRainyOption = document.querySelector('.theme-option.rainy-theme');
            if (directRainyOption) {
                console.log('Добавляем прямой обработчик onclick для дождливой темы');
                directRainyOption.onclick = function() {
                    console.log('Прямой клик на дождливую тему');
                    try {
                        setTheme('rainy');
                    } catch (error) {
                        console.error('Ошибка в прямом обработчике:', error);
                    }
                    
                    // Скрываем меню
                    const menu = document.getElementById('theme-menu');
                    if (menu) menu.classList.remove('visible');
                    
                    return false; // Предотвращаем всплытие события
                };
            }
        } catch (error) {
            console.error('Ошибка при установке прямого обработчика:', error);
        }
        
        // Создаем дополнительную кнопку для переключения на дождливую тему
        try {
            const emergencyButton = document.createElement('button');
            emergencyButton.textContent = 'Дождливая тема';
            emergencyButton.style.position = 'fixed';
            emergencyButton.style.bottom = '10px';
            emergencyButton.style.left = '10px';
            emergencyButton.style.zIndex = '9999';
            emergencyButton.style.padding = '5px 10px';
            emergencyButton.style.backgroundColor = '#546e7a';
            emergencyButton.style.color = 'white';
            emergencyButton.style.border = 'none';
            emergencyButton.style.borderRadius = '5px';
            emergencyButton.style.cursor = 'pointer';
            
            emergencyButton.onclick = function() {
                console.log('Нажата аварийная кнопка дождливой темы');
                setTheme('rainy');
            };
            
            document.body.appendChild(emergencyButton);
            console.log('Аварийная кнопка добавлена');
        } catch (error) {
            console.error('Ошибка при создании аварийной кнопки:', error);
        }
        
        // Обработчики для нового простого переключателя тем
        const simpleCosmicButton = document.getElementById('simple-cosmic-button');
        const simpleRainyButton = document.getElementById('simple-rainy-button');
        
        if (simpleCosmicButton) {
            simpleCosmicButton.addEventListener('click', function() {
                console.log('Нажата простая кнопка: Космическая тема');
                
                // Прямое применение темы без использования общей функции
                document.body.classList.remove('rainy-theme');
                document.body.classList.add('cosmic-theme');
                
                if (rainyBackground) rainyBackground.style.display = 'none';
                if (enhancedStars) enhancedStars.style.display = 'block';
                if (floatingSquares) floatingSquares.style.display = 'none';
                
                // Сохраняем выбор
                localStorage.setItem('theme', 'cosmic');
                
                // Обновляем активные кнопки
                simpleCosmicButton.classList.add('active');
                simpleRainyButton.classList.remove('active');
                
                // Удаляем все капли
                const allFlowingDrops = document.querySelectorAll('.flowing-drop');
                allFlowingDrops.forEach(drop => {
                    if (drop.parentNode) drop.parentNode.removeChild(drop);
                });
                
                console.log('Применена космическая тема');
            });
        }
        
        if (simpleRainyButton) {
            simpleRainyButton.addEventListener('click', function() {
                console.log('Нажата простая кнопка: Дождливая тема');
                window.setRainyTheme();
            });
        }
        
        // Установка начальной активной кнопки
        const currentTheme = localStorage.getItem('theme') || 'cosmic';
        if (currentTheme === 'cosmic') {
            simpleCosmicButton?.classList.add('active');
        } else {
            simpleRainyButton?.classList.add('active');
        }
    });

    // Код для круглого меню переключения тем
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOMContentLoaded: Инициализация круглого меню тем');
        
        /*
         * ВНИМАНИЕ: Все неработающие кнопки переключения темы были удалены.
         * Круглое меню (theme-circle-menu) - это единственный официальный
         * способ переключения между темами в приложении.
         */
        
        // Проверяем DOM-структуру
        const rainyBackground = document.getElementById('rainy-background');
        const enhancedStars = document.getElementById('enhanced-stars');
        
        console.log('Элементы фона:');
        console.log('- rainy-background:', rainyBackground ? 'найден' : 'НЕ НАЙДЕН');
        console.log('- enhanced-stars:', enhancedStars ? 'найден' : 'НЕ НАЙДЕН');
        
        // Глобальная функция для создания дождливого фона
        window.createRainyBackground = function() {
            console.log('Создание дождливого фона');
            
            if (!rainyBackground) {
                console.error('Элемент rainy-background не найден!');
                return;
            }
            
            // Очищаем контейнер
            rainyBackground.innerHTML = '<div class="mist"></div>';
            
            // Устанавливаем фон
            rainyBackground.style.background = 'linear-gradient(to bottom, #333333 0%, #666666 40%, #888888 100%)';
            
            // Настраиваем туман
            const mist = rainyBackground.querySelector('.mist');
            if (mist) {
                mist.style.background = 'linear-gradient(to bottom, rgba(150, 150, 150, 0.1) 0%, rgba(200, 200, 200, 0.2) 100%)';
                mist.style.opacity = '0.3';
            }
            
            // Создаем начальные капли
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    createRaindrop();
                }, i * 100);
            }
            
            // Интервал для создания новых капель
            return setInterval(() => {
                if (document.body.classList.contains('rainy-theme')) {
                    createRaindrop();
                }
            }, 100);
        };
        
        // Функция создания одной капли дождя
        function createRaindrop() {
            if (!rainyBackground) return;
            
            const drop = document.createElement('div');
            drop.className = 'raindrop';
            
            // Случайное положение
            drop.style.left = `${Math.random() * 100}%`;
            
            // Случайная скорость падения
            const duration = 0.5 + Math.random() * 1.5;
            drop.style.setProperty('--duration', `${duration}s`);
            
            // Случайная задержка начала анимации
            drop.style.setProperty('--delay', `${Math.random() * 2}s`);
            
            // Добавляем в контейнер
            rainyBackground.appendChild(drop);
            
            // Удаляем каплю после анимации
            setTimeout(() => {
                if (drop.parentNode) {
                    drop.parentNode.removeChild(drop);
                }
            }, (duration + parseFloat(drop.style.getPropertyValue('--delay')) + 1) * 1000);
        }
        
        // Инициализация круглого меню
        const themeCircleToggle = document.getElementById('theme-circle-toggle');
        const themeCircleMenuItems = document.getElementById('theme-circle-menu-items');
        const themeOptions = document.querySelectorAll('.theme-option');
        
        if (themeCircleToggle && themeCircleMenuItems) {
            console.log('Круглое меню найдено, добавляем обработчики');
            
            // Добавляем эффект пульсации
            themeCircleToggle.classList.add('pulse');
            
            // Убираем пульсацию через 5 секунд
            setTimeout(() => {
                themeCircleToggle.classList.remove('pulse');
            }, 5000);
            
            // Обработчик клика по кружку - открывает/закрывает меню
            themeCircleToggle.addEventListener('click', function(e) {
                e.stopPropagation();
                themeCircleMenuItems.classList.toggle('active');
                console.log('Меню тем переключено');
            });
            
            // Закрытие меню при клике вне его
            document.addEventListener('click', function(e) {
                if (themeCircleMenuItems.classList.contains('active') && 
                    !themeCircleMenuItems.contains(e.target) && 
                    e.target !== themeCircleToggle) {
                    themeCircleMenuItems.classList.remove('active');
                    console.log('Меню тем закрыто (клик вне)');
                }
            });
            
            // Обработчик выбора темы
            themeOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const theme = this.getAttribute('data-theme');
                    console.log(`Выбрана тема: ${theme}`);
                    
                    // Применяем выбранную тему
                    applyTheme(theme);
                    
                    // Обновляем активную тему в меню
                    themeOptions.forEach(opt => {
                        opt.classList.toggle('active', opt.getAttribute('data-theme') === theme);
                    });
                    
                    // Закрываем меню
                    themeCircleMenuItems.classList.remove('active');
                });
            });
            
            // Применяем сохраненную тему при загрузке
            const savedTheme = localStorage.getItem('theme') || 'cosmic';
            console.log('Загружена тема:', savedTheme);
            applyTheme(savedTheme);
            
            // Отмечаем активную тему в меню
            themeOptions.forEach(option => {
                if (option.getAttribute('data-theme') === savedTheme) {
                    option.classList.add('active');
                } else {
                    option.classList.remove('active');
                }
            });
        } else {
            console.error('Ошибка: круглое меню не найдено!');
        }
        
        // Функция применения темы
        function applyTheme(theme) {
            console.log('Применяется тема:', theme);
            
            // Обновляем классы на body
            if (theme === 'cosmic') {
                document.body.classList.remove('rainy-theme');
                document.body.classList.add('cosmic-theme');
            } else if (theme === 'rainy') {
                window.setRainyTheme();
                return; // Выходим, так как функция setRainyTheme делает все нужные действия
            }
            
            // Обновляем видимость фонов
            if (enhancedStars && rainyBackground) {
                if (theme === 'cosmic') {
                    enhancedStars.style.display = 'block';
                    rainyBackground.style.display = 'none';
                    
                    // Удаляем все капли дождя
                    const allDrops = document.querySelectorAll('.raindrop');
                    allDrops.forEach(drop => {
                        if (drop.parentNode) drop.parentNode.removeChild(drop);
                    });
                } else if (theme === 'rainy') {
                    enhancedStars.style.display = 'none';
                    rainyBackground.style.display = 'block';
                    
                    // Создаем дождливый фон, если его еще нет
                    if (!rainyBackground.querySelector('.raindrop')) {
                        window.createRainyBackground();
                    }
                }
            }
            
            // Сохраняем выбор в localStorage
            localStorage.setItem('theme', theme);
        }
    });

    // Инициализация кругового меню
    function initThemeCircleMenu() {
        // ... existing code ...
    }

    // Добавление обработчика события для кнопки переключения темы в хедере
    document.addEventListener('DOMContentLoaded', function() {
        // Инициализация кругового меню (на случай, если оно понадобится)
        initThemeCircleMenu();
        
        // Найти кнопку переключения темы в хедере
        const headerThemeToggle = document.querySelector('.theme-toggle');
        
        // Добавить обработчик клика, если элемент найден
        if (headerThemeToggle) {
            headerThemeToggle.addEventListener('click', function() {
                // Переключение между темами
                const currentTheme = localStorage.getItem('theme') || 'default';
                let nextTheme;
                
                // Определить следующую тему
                if (currentTheme === 'default') {
                    nextTheme = 'cosmic';
                } else if (currentTheme === 'cosmic') {
                    nextTheme = 'rainy';
                } else {
                    nextTheme = 'default';
                }
                
                // Установить новую тему
                setTheme(nextTheme);
                
                // Обновить активные опции в круговом меню (если оно присутствует)
                updateActiveThemeOption();
            });
        }
    });

    // Функция обновления активной темы в меню
    // ... existing code ...

    // Добавление обработчика события для кнопки переключения темы в хедере
    document.addEventListener('DOMContentLoaded', function() {
        // Инициализация кругового меню (на случай, если оно понадобится)
        // initThemeCircleMenu();
        
        // Обработчик события изменения темы
        document.addEventListener('themeChanged', function(event) {
            console.log('Событие themeChanged получено в main.html, тема:', event.detail.theme);
            
            // Проверяем наличие круглого меню и обновляем активные опции
            const circleThemeOptions = document.querySelectorAll('.theme-circle-menu-items .theme-option');
            if (circleThemeOptions.length > 0) {
                circleThemeOptions.forEach(option => {
                    option.classList.toggle('active', option.getAttribute('data-theme') === event.detail.theme);
                });
            }
            
            // Проверяем наличие стандартного меню и обновляем активные опции
            const standardThemeOptions = document.querySelectorAll('.theme-menu .theme-option');
            if (standardThemeOptions.length > 0) {
                standardThemeOptions.forEach(option => {
                    option.classList.toggle('active', option.getAttribute('data-theme') === event.detail.theme);
                });
            }
            
            // Обновляем простые кнопки, если они есть
            try {
                const simpleCosmicBtn = document.getElementById('simple-cosmic-button');
                const simpleRainyBtn = document.getElementById('simple-rainy-button');
                
                if (simpleCosmicBtn && simpleRainyBtn) {
                    if (event.detail.theme === 'cosmic') {
                        simpleCosmicBtn.classList.add('active');
                        simpleRainyBtn.classList.remove('active');
                    } else if (event.detail.theme === 'rainy') {
                        simpleRainyBtn.classList.add('active');
                        simpleCosmicBtn.classList.remove('active');
                    }
                }
            } catch (error) {
                console.error('Ошибка при обновлении простых кнопок:', error);
            }
        });
    });

    // Функция обновления активной темы в меню
    // ... existing code ...

    // Слушатель события для элементов, загруженных динамически
    document.addEventListener('themeChanged', function(e) {
        console.log('Событие смены темы получено, новая тема:', e.detail.theme);
        
        // Обновляем QR-код при смене темы, если текущая новость активна
        if (newsItems.length > 0 && currentNewsIndex >= 0) {
            updateQRCode(newsItems[currentNewsIndex]);
        }
    });

    // Функция для поиска и обновления QR-кода с помощью источника
    function updateNewsQRCode(sourceUrl) {
        // По умолчанию ЦБ РФ
        let qrCode = qrCodeSources['cbr.ru'];
        
        // Определяем источник по URL
        if (sourceUrl.includes('cbr.ru') || sourceUrl.includes('centralbank')) {
            qrCode = qrCodeSources['cbr.ru'];
        } else if (sourceUrl.includes('kommersant.ru') || sourceUrl.includes('kommersant')) {
            qrCode = qrCodeSources['kommersant.ru'];
        } else if (sourceUrl.includes('rambler.ru') || sourceUrl.includes('rambler')) {
            qrCode = qrCodeSources['rambler.ru'];
        }
        
        // Проверяем активную тему
        const isRainyTheme = document.body.classList.contains('rainy-theme');
        const imageUrl = isRainyTheme && qrCode.rainyUrl ? qrCode.rainyUrl : qrCode.url;
        
        // Для отладки
        console.log('Обновление QR-кода при смене темы:');
        console.log('Источник новости:', sourceUrl);
        console.log('Выбран QR-код для:', qrCode.name);
        console.log('Дождливая тема активна:', isRainyTheme);
        console.log('Путь к изображению QR-кода:', imageUrl);
        
        // Обновляем QR-код без анимации
        const qrCodeImage = document.getElementById('qr-image');
        qrCodeImage.src = imageUrl;
        qrCodeImage.alt = qrCode.name;
        qrSource.textContent = qrCode.name;
        
        // Добавляем обработчики для отладки
        qrCodeImage.onload = function() {
            console.log('QR-код успешно загружен после смены темы:', imageUrl);
        };
        
        qrCodeImage.onerror = function() {
            console.error('Ошибка загрузки QR-кода после смены темы:', imageUrl);
            console.log('Полный URL после обработки Django:', this.src);
        };
    }

    // Функция для обновления QR-кода новости

    // Глобальная функция для установки дождливой темы с глитч-эффектом
    window.setRainyTheme = function() {
        console.log('Установка дождливой (серой) темы с глитч-эффектом');
        
        // Обновляем классы на body
        document.body.classList.add('rainy-theme');
        document.body.classList.remove('cosmic-theme');
        
        // Настраиваем отображение фонов
        const rainyBg = document.getElementById('rainy-background');
        const enhancedStrs = document.getElementById('enhanced-stars');
        const floatingSquares = document.getElementById('floating-squares');
        
        if (enhancedStrs) enhancedStrs.style.display = 'none';
        
        // Настраиваем плавающие квадраты для серой темы
        if (floatingSquares) {
            floatingSquares.style.display = 'block';
            floatingSquares.style.zIndex = '0'; // Снижаем z-index, чтобы не перекрывать футер
            console.log('Плавающие квадраты активированы в серой теме');
        } else {
            console.error('Элемент floating-squares не найден!');
        }
        
        if (rainyBg) {
            // Очищаем содержимое, чтобы избежать накопления элементов
            rainyBg.innerHTML = '<div class="mist"></div>';
            rainyBg.style.display = 'block';
            rainyBg.style.zIndex = '1'; // Низкий z-index, чтобы быть позади квадратов
            
            // Создаем глитч-эффект
            try {
                window.createRainyBackgroundGlobal();
            } catch (error) {
                console.error('Ошибка при создании глитч-эффекта:', error);
            }
        }
        
        // Сохраняем в localStorage
        localStorage.setItem('theme', 'rainy');
        
        // Активируем соответствующие кнопки меню
        const simpleCosmicBtn = document.getElementById('simple-cosmic-button');
        const simpleRainyBtn = document.getElementById('simple-rainy-button');
        
        if (simpleCosmicBtn) simpleCosmicBtn.classList.remove('active');
        if (simpleRainyBtn) simpleRainyBtn.classList.add('active');
        
        console.log('Дождливая тема с глитч-эффектом установлена');
    };
</script>
{% endblock %}
