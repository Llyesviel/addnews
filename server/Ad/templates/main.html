{% extends 'base.html' %}
{% load static %}

{% block title %}Экономические Новости - Главная{% endblock %}

{% block style %}
<style>
    html, body {
        background-color: transparent !important;
        min-height: 100vh;
        margin: 0;
        padding: 0;
        overflow-x: hidden;
        scrollbar-width: thin;
    }
    
    /* Стили для улучшенного звездного фона */
    .enhanced-stars-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
        pointer-events: none;
        overflow: hidden;
    }
    
    /* Базовые стили для звезд */
    .star {
        position: absolute;
        background-color: #fff;
        border-radius: 50%;
        opacity: 0;
        animation: twinkle var(--duration, 4s) ease-in-out infinite;
        animation-delay: var(--delay, 0s);
    }
    
    /* Размеры звезд */
    .star.tiny {
        width: 1px;
        height: 1px;
        box-shadow: 0 0 1px rgba(255, 255, 255, 0.3);
    }
    
    .star.small {
        width: 2px;
        height: 2px;
        box-shadow: 0 0 2px rgba(255, 255, 255, 0.5);
    }
    
    .star.medium {
        width: 3px;
        height: 3px;
        box-shadow: 0 0 3px 1px rgba(255, 255, 255, 0.6);
    }
    
    .star.large {
        width: 4px;
        height: 4px;
        box-shadow: 0 0 4px 2px rgba(255, 255, 255, 0.8);
    }
    
    /* Звезды с особым свечением */
    .star.bright {
        background: radial-gradient(circle, rgba(255, 255, 255, 1) 0%, rgba(255, 255, 255, 0.3) 70%, rgba(255, 255, 255, 0) 100%);
        width: 6px;
        height: 6px;
        box-shadow: 0 0 10px 2px rgba(255, 255, 255, 0.7);
        animation: bright-twinkle var(--duration, 6s) ease-in-out infinite;
        animation-delay: var(--delay, 0s);
    }
    
    /* Падающие звезды (метеоры) */
    .meteor {
        position: absolute;
        width: 2px;
        height: 1px;
        background: linear-gradient(to right, rgba(255, 255, 255, 0), rgba(255, 255, 255, 1) 50%, rgba(255, 255, 255, 0));
        transform: rotate(-35deg);
        opacity: 0;
        top: calc(var(--top, 0.3) * 100%);
        left: calc(var(--left, 0.5) * 100%);
        animation: meteor 8s linear infinite;
        animation-delay: var(--delay, 0s);
        z-index: 1;
    }
    
    /* Туманности */
    .nebula {
        position: absolute;
        width: 150px;
        height: 150px;
        border-radius: 50%;
        background: radial-gradient(ellipse at center, 
                                    rgba(63, 81, 181, 0.05) 0%, 
                                    rgba(76, 0, 153, 0.03) 50%, 
                                    rgba(15, 11, 50, 0) 70%);
        opacity: 0.3;
        animation: pulse 15s ease-in-out infinite;
        animation-delay: var(--delay, 0s);
        transform: scale(var(--scale, 1));
        z-index: 0;
        mix-blend-mode: screen;
    }
    
    /* Анимации */
    @keyframes twinkle {
        0%, 100% { opacity: 0.1; transform: scale(1); }
        50% { opacity: 0.9; transform: scale(1.2); }
    }
    
    @keyframes bright-twinkle {
        0%, 100% { opacity: 0.5; transform: scale(1); filter: blur(0px); }
        25% { opacity: 1; transform: scale(1.1); filter: blur(0px); }
        50% { opacity: 0.7; transform: scale(1.3); filter: blur(1px); }
        75% { opacity: 1; transform: scale(1.1); filter: blur(0px); }
    }
    
    @keyframes meteor {
        0% {
            opacity: 0;
            width: 0;
            transform: translateX(0) translateY(0) rotate(-35deg);
        }
        5% {
            opacity: 1;
            width: 120px;
        }
        20% {
            opacity: 1;
        }
        30% {
            opacity: 0;
            width: 0;
            transform: translateX(900px) translateY(900px) rotate(-35deg);
        }
        100% {
            opacity: 0;
            width: 0;
            transform: translateX(900px) translateY(900px) rotate(-35deg);
        }
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 0.3; transform: scale(var(--scale, 1)); }
        50% { opacity: 0.5; transform: scale(calc(var(--scale, 1) * 1.2)); }
    }
    
    /* Стили для скроллбара body */
    body::-webkit-scrollbar {
        width: 8px;
    }

    body::-webkit-scrollbar-track {
        background: transparent;
    }

    body::-webkit-scrollbar-thumb {
        background-color: rgba(255, 255, 255, 0.3);
        border-radius: 10px;
        border: 2px solid transparent;
    }

    body::-webkit-scrollbar-thumb:hover {
        background-color: rgba(255, 255, 255, 0.5);
    }

    /* Принудительно делаем все контейнеры с прозрачным фоном */
    .container, 
    .content-container,
    .wrapper,
    .page-wrapper,
    .main-wrapper {
        background-color: transparent !important;
    }

    .main-content {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        flex: 1;
        overflow: hidden;
        width: 100%;
        gap: 25px;
        padding: 15px 0;
        background-color: transparent;
        position: relative;
        z-index: 2; /* Повышаем z-index, чтобы контент был над звездами */
    }

    .news-content, .qr-section {
        align-self: flex-start;
    }

    .news-content {
        background-color: rgba(255, 255, 255, 0.97);
        padding: 25px 30px;
        border-radius: 30px;
        width: 68%;
        flex: 0 0 auto;
        overflow-y: auto;
        box-sizing: border-box;
        font-size: 1.5rem;
        margin-left: 15px;
        margin-top: 100px;
        scrollbar-width: thin;
        -ms-overflow-style: none;
        max-height: 75vh;
        position: relative;
        box-shadow: 0 8px 32px rgba(31, 38, 135, 0.2);
        backdrop-filter: blur(4px);
        border: 1px solid rgba(255, 255, 255, 0.18);
        transition: all 0.3s ease;
    }

    .news-content:hover {
        box-shadow: 0 8px 32px rgba(13, 17, 68, 0.3);
        transform: translateY(-3px);
    }

    .news-content::-webkit-scrollbar {
        width: 6px;
    }

    .news-content::-webkit-scrollbar-track {
        background: transparent;
    }

    .news-content::-webkit-scrollbar-thumb {
        background-color: rgba(35, 28, 92, 0.5);
        border-radius: 10px;
    }

    .news-content::-webkit-scrollbar-thumb:hover {
        background-color: rgba(35, 28, 92, 0.8);
    }

    .qr-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        padding-top: 20px;
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 30px;
        margin-right: 15px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        width: 28%;
        flex: 0 0 auto;
    }

    .qr-section img {
        width: 85%;
        height: auto;
        transition: all 0.3s ease-in-out;
        border-radius: 8px;
        opacity: 1;
        margin-bottom: 15px;
    }

    .qr-section img:hover {
        transform: scale(1.05);
    }

    .qr-section span {
        font-weight: bold;
        font-size: 1.5rem;
        color: white;
        margin-top: 8px;
    }

    .qr-source {
        font-weight: bold;
        font-size: 1.4rem;
        color: #1a237e;
        margin-top: 15px;
        text-align: center;
        transition: all 0.3s ease;
        padding: 8px 15px;
        background-color: rgba(255, 255, 255, 0.95);
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        border: 1px solid #e0e0e0;
        position: relative;
        display: inline-block;
    }

    .qr-source:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        color: #3f51b5;
    }

    .qr-source::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        width: 0;
        height: 2px;
        background-color: #3f51b5;
        transition: all 0.3s ease;
        transform: translateX(-50%);
    }

    .qr-source:hover::after {
        width: 80%;
    }

    .news-content h2 {
        font-size: 2.5rem;
        font-weight: bold;
        margin-top: 0;
        margin-bottom: 25px;
        color: #231c5c;
        border-bottom: 2px solid rgba(35, 28, 92, 0.15);
        padding-bottom: 12px;
        position: relative;
    }

    .news-content h2::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 60px;
        height: 2px;
        background: linear-gradient(90deg, #3949ab, #231c5c);
    }

    .news-content p {
        font-size: 1.5rem;
        line-height: 1.7;
        margin-bottom: 20px;
        color: #333;
    }

    .news-item {
        margin-top: 0;
        position: relative;
        padding-bottom: 15px;
        animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .news-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
    }

    .navigation-buttons {
        display: flex;
        gap: 10px;
    }

    .nav-button {
        background-color: #231c5c;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 8px 15px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background-color 0.3s, transform 0.2s;
    }

    .nav-button:hover {
        background-color: #1a1461;
        transform: translateY(-2px);
    }

    .nav-button:active {
        transform: translateY(0);
    }

    .timer-container {
        position: relative;
        width: 40px;
        height: 40px;
    }

    .timer-svg {
        transform: rotate(-90deg);
        width: 100%;
        height: 100%;
    }

    .timer-circle-bg {
        fill: none;
        stroke: #e6e6e6;
        stroke-width: 3.5;
    }

    .timer-circle-progress {
        fill: none;
        stroke: #231c5c;
        stroke-width: 3.5;
        stroke-linecap: round;
        stroke-dasharray: 125.6;
        stroke-dashoffset: 125.6;
        animation: countdown 20s linear forwards;
    }

    @keyframes countdown {
        from {
            stroke-dashoffset: 125.6;
        }
        to {
            stroke-dashoffset: 0;
        }
    }

    .timer-center {
        position: absolute;
        top: 5px;
        left: 5px;
        width: 30px;
        height: 30px;
        background-color: white;
        border-radius: 50%;
        z-index: 1;
    }

    .news-ratings {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .rating-button {
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        background: none;
        cursor: pointer;
        padding: 5px;
        transition: transform 0.2s, opacity 0.3s;
        opacity: 0.7;
        color: #231c5c;
    }

    .rating-button:hover {
        transform: scale(1.1);
        opacity: 1;
    }

    .rating-button.active {
        opacity: 1;
    }

    .like-button .rating-icon {
        width: 20px;
        height: 20px;
        display: inline-block;
        margin-right: 5px;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23231c5c"><path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-1.91l-.01-.01L23 10z"/></svg>');
    }

    .dislike-button .rating-icon {
        width: 20px;
        height: 20px;
        display: inline-block;
        margin-right: 5px;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23231c5c"><path d="M15 3H6c-.83 0-1.54.5-1.84 1.22l-3.02 7.05c-.09.23-.14.47-.14.73v1.91l.01.01L1 14c0 1.1.9 2 2 2h6.31l-.95 4.57-.03.32c0 .41.17.79.44 1.06L9.83 23l6.59-6.59c.36-.36.58-.86.58-1.41V5c0-1.1-.9-2-2-2zm4 0v12h4V3h-4z"/></svg>');
    }

    .comment-button .rating-icon {
        width: 20px;
        height: 20px;
        display: inline-block;
        margin-right: 5px;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23231c5c"><path d="M21.99 4c0-1.1-.89-2-1.99-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4-.01-18zM18 14H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>');
    }

    .like-button.active .rating-icon {
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%233949ab"><path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-1.91l-.01-.01L23 10z"/></svg>');
    }

    .dislike-button.active .rating-icon {
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%233949ab"><path d="M15 3H6c-.83 0-1.54.5-1.84 1.22l-3.02 7.05c-.09.23-.14.47-.14.73v1.91l.01.01L1 14c0 1.1.9 2 2 2h6.31l-.95 4.57-.03.32c0 .41.17.79.44 1.06L9.83 23l6.59-6.59c.36-.36.58-.86.58-1.41V5c0-1.1-.9-2-2-2zm4 0v12h4V3h-4z"/></svg>');
    }

    .rating-count {
        font-size: 0.9rem;
    }

    .background-image {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: -1;
        opacity: 0.5;
    }

    /* Стили для модального окна с комментариями */
    .comments-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(8, 15, 30, 0.85); /* Тёмно-синий оттенок, как звездное небо, но с высокой прозрачностью */
        backdrop-filter: blur(5px); /* Добавляем размытие фона */
    }

    .comments-modal-content {
        position: relative;
        background-color: rgba(255, 255, 255, 0.95);
        margin: 5% auto;
        padding: 20px;
        border-radius: 15px;
        width: 60%;
        max-width: 800px;
        box-shadow: 0 5px 25px rgba(0, 0, 0, 0.4);
        animation: modalopen 0.3s;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    @keyframes modalopen {
        from {opacity: 0; transform: scale(0.9);}
        to {opacity: 1; transform: scale(1);}
    }

    .close-modal {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.3s;
    }

    .close-modal:hover,
    .close-modal:focus {
        color: #231c5c;
        text-decoration: none;
    }

    .comments-header {
        border-bottom: 1px solid #ddd;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }

    .comments-header h3 {
        margin: 0;
        font-size: 1.5rem;
        color: #231c5c;
    }

    .comments-list {
        max-height: 400px;
        overflow-y: auto;
        margin-bottom: 20px;
    }

    .comment-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
    }

    .comment-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
    }

    .comment-username {
        font-weight: bold;
        color: #231c5c;
    }

    .comment-date {
        color: #777;
        font-size: 0.8rem;
    }

    .comment-text {
        margin-bottom: 5px;
    }

    .comment-form {
        display: flex;
        flex-direction: column;
    }

    .comment-textarea {
        width: 100%;
        min-height: 80px;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        resize: vertical;
        font-family: inherit;
    }

    .comment-submit {
        align-self: flex-end;
        background-color: #231c5c;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 8px 15px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .comment-submit:hover {
        background-color: #3949ab;
    }

    .no-comments {
        text-align: center;
        color: #777;
        padding: 20px;
    }

    .error-message {
        color: #f44336;
        margin-bottom: 10px;
    }

    /* Медиа-запросы для отзывчивости */
    @media (max-width: 1200px) {
        .main-content {
            gap: 20px;
        }
        
        .news-content {
            width: 65%;
            margin-left: 10px;
            margin-top: 40px;
        }
        
        .qr-section {
            width: 30%;
            margin-right: 10px;
        }
    }

    @media (max-width: 992px) {
        .main-content {
            flex-direction: column;
            align-items: center;
            padding: 10px 0;
        }
        
        .news-content {
            width: 90%;
            max-height: 55vh;
            margin-left: 0;
            margin-top: 25px;
            margin-bottom: 15px;
        }
        
        .qr-section {
            width: 40%;
            margin-right: 0;
        }
        
        .qr-section img {
            width: 70%;
        }
        
        .qr-source {
            font-size: 1.3rem;
            padding: 6px 12px;
        }
    }

    @media (max-width: 576px) {
        .main-content {
            padding: 5px 0;
        }
        
        .news-content {
            width: 95%;
            padding: 15px;
            margin-top: 15px;
            margin-bottom: 10px;
        }
        
        .news-content h2 {
            font-size: 2rem;
        }
        
        .news-content p {
            font-size: 1.2rem;
        }
        
        .qr-section {
            width: 60%;
        }
        
        .qr-source {
            font-size: 1.2rem;
            padding: 5px 10px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Улучшенный звездный фон -->
<div class="enhanced-stars-container" id="enhanced-stars">
    <!-- Здесь будут динамически созданные звезды и метеоры -->
</div>

<div class="main-content">
    <div class="news-content">
        {% for news in news_list %}
        <div class="news-item" data-index="{{ forloop.counter0 }}" data-id="{{ news.id }}" data-source-url="{% if news.source %}{{ news.source.feed_url }}{% endif %}">
            <h2>{{ news.title }}</h2>
            <p>{{ news.description }}</p>
            <div class="news-controls">
                <div class="news-ratings">
                    <button class="rating-button like-button {% if news.user_rating == 'like' %}active{% endif %}" data-news-id="{{ news.id }}" data-rating="like">
                        <span class="rating-icon"></span>
                        <span class="rating-count">{{ news.likes_count }}</span>
                    </button>
                    <button class="rating-button dislike-button {% if news.user_rating == 'dislike' %}active{% endif %}" data-news-id="{{ news.id }}" data-rating="dislike">
                        <span class="rating-icon"></span>
                        <span class="rating-count">{{ news.dislikes_count }}</span>
                    </button>
                    <button class="rating-button comment-button" data-news-id="{{ news.id }}">
                        <span class="rating-icon"></span>
                        <span class="rating-count">{{ news.comments_count }}</span>
                    </button>
                </div>
                <div class="navigation-buttons">
                    <button class="nav-button back-button" data-index="{{ forloop.counter0 }}">Назад</button>
                    <button class="nav-button skip-button" data-index="{{ forloop.counter0 }}">Пропустить</button>
                </div>
                <div class="timer-container">
                    <svg class="timer-svg" viewBox="0 0 44 44">
                        <circle class="timer-circle-bg" cx="22" cy="22" r="20"></circle>
                        <circle class="timer-circle-progress" cx="22" cy="22" r="20"></circle>
                    </svg>
                    <div class="timer-center"></div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    <div class="qr-section">
        <img id="qr-image" src="{% static 'Ad/images/qr-placeholder.png' %}" alt="QR код">
        <div class="qr-source" id="qr-source">Источник новости</div>
    </div>
</div>

<!-- Модальное окно с комментариями -->
<div id="comments-modal" class="comments-modal">
    <div class="comments-modal-content">
        <span class="close-modal">&times;</span>
        <div class="comments-header">
            <h3>Комментарии</h3>
        </div>
        <div class="comments-list" id="comments-list">
            <!-- Сюда будут добавляться комментарии -->
            <div class="no-comments">
                Комментариев пока нет. Будьте первым!
            </div>
        </div>
        <div class="comment-form" id="comment-form">
            <div class="error-message" id="comment-error" style="display: none;"></div>
            <textarea class="comment-textarea" id="comment-text" placeholder="Напишите комментарий..."></textarea>
            <button class="comment-submit" id="comment-submit">Отправить</button>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Создаем улучшенный звездный фон
        function createEnhancedStarryBackground() {
            const container = document.getElementById('enhanced-stars');
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            
            // Добавляем мерцающие звезды разных размеров
            const starTypes = ['tiny', 'small', 'medium', 'large', 'bright'];
            const starCounts = [150, 100, 50, 25, 10]; // Количество звезд каждого типа
            
            starTypes.forEach((type, index) => {
                for (let i = 0; i < starCounts[index]; i++) {
                    const star = document.createElement('div');
                    star.className = `star ${type}`;
                    
                    // Распределяем звезды по экрану
                    star.style.left = `${Math.random() * 100}%`;
                    star.style.top = `${Math.random() * 100}%`;
                    
                    // Назначаем случайные длительности и задержки для анимации
                    const duration = type === 'bright' ? 6 + Math.random() * 6 : 3 + Math.random() * 4;
                    star.style.setProperty('--duration', `${duration}s`);
                    star.style.setProperty('--delay', `${Math.random() * 5}s`);
                    
                    container.appendChild(star);
                }
            });
            
            // Создаем туманности с разными параметрами
            for (let i = 0; i < 4; i++) {
                const nebula = document.createElement('div');
                nebula.className = 'nebula';
                
                // Распределяем туманности по экрану
                nebula.style.left = `${Math.random() * 100}%`;
                nebula.style.top = `${Math.random() * 100}%`;
                
                // Добавляем случайные параметры для анимации
                nebula.style.setProperty('--delay', `${Math.random() * 10}s`);
                nebula.style.setProperty('--scale', `${1 + Math.random() * 1.5}`);
                
                // Случайный поворот для разнообразия
                nebula.style.transform = `scale(var(--scale, 1)) rotate(${Math.random() * 360}deg)`;
                
                container.appendChild(nebula);
            }
            
            // Функция для периодического создания метеоров
            function createMeteor() {
                const meteor = document.createElement('div');
                meteor.className = 'meteor';
                
                // Случайная позиция для начала метеора (в верхней части экрана)
                const topPosition = Math.random() * 0.3; // 0-30% сверху
                const leftPosition = 0.1 + Math.random() * 0.8; // 10-90% слева
                
                meteor.style.setProperty('--top', `${topPosition}`);
                meteor.style.setProperty('--left', `${leftPosition}`);
                
                // Добавляем метеор на страницу
                container.appendChild(meteor);
                
                // Удаляем метеор после завершения анимации
                setTimeout(() => {
                    meteor.remove();
                }, 8000); // Время жизни метеора (должно быть >= времени анимации)
            }
            
            // Изначально создаем несколько метеоров
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    createMeteor();
                }, i * 2000); // Распределяем создание по времени
            }
            
            // Периодически создаем новые метеоры
            setInterval(() => {
                createMeteor();
            }, 8000 + Math.random() * 5000); // Случайный интервал между метеорами
        }
        
        // Вызываем функцию создания звездного фона
        createEnhancedStarryBackground();
        
        // Обеспечиваем прозрачный фон для всех родительских элементов
        function setTransparentBg() {
            // Получаем текущий элемент
            let currentElement = document.querySelector('.main-content');
            
            // Пока не дошли до body, делаем фон родителей прозрачным
            while (currentElement && currentElement.parentElement) {
                currentElement = currentElement.parentElement;
                if (currentElement.tagName !== 'HTML') {
                    currentElement.style.backgroundColor = 'transparent';
                }
            }
        }
        
        // Выполняем при загрузке страницы
        setTransparentBg();
        
        // И также при прокрутке для надежности
        window.addEventListener('scroll', setTransparentBg);
        
        const newsItems = document.querySelectorAll('.news-item');
        const skipButtons = document.querySelectorAll('.skip-button');
        const likeButtons = document.querySelectorAll('.like-button');
        const dislikeButtons = document.querySelectorAll('.dislike-button');
        const backButtons = document.querySelectorAll('.back-button');
        const commentButtons = document.querySelectorAll('.comment-button');
        const commentsModal = document.getElementById('comments-modal');
        const closeModal = document.querySelector('.close-modal');
        const commentsList = document.getElementById('comments-list');
        const commentForm = document.getElementById('comment-form');
        const commentText = document.getElementById('comment-text');
        const commentSubmit = document.getElementById('comment-submit');
        const commentError = document.getElementById('comment-error');
        const qrImage = document.getElementById('qr-image');
        const qrSource = document.getElementById('qr-source');
        
        // Переменные для хранения текущего ID новости в модальном окне
        let currentNewsId = null;
        
        // Карта QR-кодов для разных источников
        const qrCodeSources = {
            'cbr.ru': {
                url: "{% static 'Ad/images/cb.png' %}",
                name: "Центральный Банк РФ"
            },
            'kommersant.ru': {
                url: "{% static 'Ad/images/kom.png' %}",
                name: "Коммерсант"
            },
            'rambler.ru': {
                url: "{% static 'Ad/images/rem.png' %}",
                name: "Рамблер"
            }
        };
        
        // Получаем информацию об аутентификации пользователя из шаблона Django
        const userAuthenticated = "{{ user.is_authenticated|yesno:'true,false' }}";
        const loginUrl = "{% url 'login' %}";

        let currentNewsIndex = 0;
        let timer;

        function showNews(index) {
            // Убедимся, что индекс в допустимом диапазоне
            if (index < 0) {
                index = newsItems.length - 1;
            } else if (index >= newsItems.length) {
                index = 0;
            }
            currentNewsIndex = index;

            // Сбрасываем и перезапускаем таймер анимации
            const timerProgressCircles = document.querySelectorAll('.timer-circle-progress');
            timerProgressCircles.forEach(circle => {
                circle.style.animation = 'none';
                circle.offsetHeight;
                circle.style.animation = 'countdown 20s linear forwards';
            });

            // Скрываем все новости и показываем только текущую
            newsItems.forEach((item, i) => {
                item.style.display = (i === index) ? 'block' : 'none';
            });
            
            // Обновляем QR-код в зависимости от источника новости
            updateQRCode(newsItems[index]);

            // Очищаем предыдущий таймер и устанавливаем новый
            clearTimeout(timer);
            timer = setTimeout(() => {
                showNews((currentNewsIndex + 1) % newsItems.length);
            }, 20000);
        }
        
        // Функция для определения источника новости и обновления QR-кода
        function updateQRCode(newsItem) {
            // Получаем URL источника из атрибута data-source-url
            const sourceUrl = newsItem.dataset.sourceUrl || '';
            
            // По умолчанию ЦБ РФ
            let qrCode = qrCodeSources['cbr.ru'];
            
            // Определяем источник по URL
            if (sourceUrl.includes('cbr.ru') || sourceUrl.includes('centralbank')) {
                qrCode = qrCodeSources['cbr.ru'];
            } else if (sourceUrl.includes('kommersant.ru') || sourceUrl.includes('kommersant')) {
                qrCode = qrCodeSources['kommersant.ru'];
            } else if (sourceUrl.includes('rambler.ru') || sourceUrl.includes('rambler')) {
                qrCode = qrCodeSources['rambler.ru'];
            }
            
            // Для отладки
            console.log('Источник новости:', sourceUrl, 'выбран QR-код:', qrCode.name);
            
            // Добавляем анимацию fadeout/fadein
            qrImage.style.opacity = '0';
            qrSource.style.opacity = '0';
            
            setTimeout(() => {
                // Обновляем изображение и текст
                qrImage.src = qrCode.url;
                qrSource.textContent = qrCode.name;
                
                // Плавно возвращаем видимость
                qrImage.style.opacity = '1';
                qrSource.style.opacity = '1';
            }, 300);
        }

        // Инициализация показа новостей
        if (newsItems.length > 0) {
            showNews(currentNewsIndex);
        }

        // Обработчики для кнопки "Назад"
        backButtons.forEach(button => {
            button.addEventListener('click', () => {
                showNews(currentNewsIndex - 1);

                // AJAX запрос для уведомления сервера
                fetch("/api/skip-news/", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken(),
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({direction: 'back'})
                })
                .then(response => {
                    if (!response.ok) {
                        console.error(`Ошибка при отправке уведомления: ${response.status}`);
                    }
                })
                .catch(error => {
                    console.error('Ошибка при отправке уведомления:', error);
                });
            });
        });

        // Добавляем обработчики для кнопки "Пропустить"
        skipButtons.forEach(button => {
            button.addEventListener('click', () => {
                showNews(currentNewsIndex + 1);

                // AJAX запрос для уведомления сервера
                fetch("/api/skip-news/", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken(),
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({direction: 'forward'})
                })
                .then(response => {
                    if (!response.ok) {
                        console.error(`Ошибка при отправке уведомления: ${response.status}`);
                    }
                })
                .catch(error => {
                    console.error('Ошибка при отправке уведомления:', error);
                });
            });
        });

        // Обработчики событий для кнопок оценки
        function handleRatingClick(button, rating) {
            const newsId = button.dataset.newsId;
            const ratingType = button.dataset.rating;

            // AJAX запрос для отправки оценки
            fetch("/api/rate-news/", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken(),
                    'Accept': 'application/json' // Явно указываем, что ожидаем JSON
                },
                body: JSON.stringify({
                    news_id: newsId,
                    rating_type: ratingType
                })
            })
            .then(response => {
                if (!response.ok) {
                    console.error(`HTTP ошибка! Статус: ${response.status}`);
                    return response.text().then(text => {
                        console.error("Содержимое ответа:", text);
                        throw new Error(`HTTP ошибка! Статус: ${response.status}`);
                    });
                }
                
                // Проверка типа содержимого на валидность JSON
                const contentType = response.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    return response.text().then(text => {
                        console.error("Неверный тип содержимого:", contentType);
                        console.error("Содержимое ответа:", text);
                        throw new Error(`Неожиданный тип содержимого: ${contentType}`);
                    });
                }
                
                return response.json();
            })
            .then(data => {
                console.log("Успешный ответ:", data);
                if (data.status === 'success' || data.status === 'removed') {
                    // Обновляем счетчики лайков и дизлайков
                    const newsItem = document.querySelector(`.news-item[data-id="${newsId}"]`);
                    const likeButton = newsItem.querySelector('.like-button');
                    const dislikeButton = newsItem.querySelector('.dislike-button');

                    likeButton.querySelector('.rating-count').textContent = data.likes;
                    dislikeButton.querySelector('.rating-count').textContent = data.dislikes;

                    // Обновляем активный класс кнопок
                    if (data.status === 'success') {
                        if (ratingType === 'like') {
                            likeButton.classList.add('active');
                            dislikeButton.classList.remove('active');
                        } else {
                            dislikeButton.classList.add('active');
                            likeButton.classList.remove('active');
                        }
                    } else {
                        // Если оценка была удалена
                        button.classList.remove('active');
                    }
                } else if (data.status === 'error') {
                    console.error('Ошибка:', data.message);
                    alert(`Ошибка при оценке новости: ${data.message}`);
                }
            })
            .catch(error => {
                console.error('Ошибка при обработке запроса:', error);
                alert('Произошла ошибка при отправке оценки. Пожалуйста, попробуйте еще раз.');
            });
        }

        // Функция для проверки авторизации и вызова соответствующего действия
        function handleRatingButtonClick(button, ratingType) {
            if (userAuthenticated === "true") {
                handleRatingClick(button, ratingType);
            } else {
                alert('Пожалуйста, войдите в систему, чтобы оценивать новости.');
                window.location.href = loginUrl;
            }
        }

        // Обработчик для кнопок лайков
        likeButtons.forEach(button => {
            button.addEventListener('click', () => handleRatingButtonClick(button, 'like'));
        });

        // Обработчик для кнопок дизлайков
        dislikeButtons.forEach(button => {
            button.addEventListener('click', () => handleRatingButtonClick(button, 'dislike'));
        });
        
        // Функция для загрузки комментариев к новости
        function loadComments(newsId) {
            commentsList.innerHTML = '<div class="no-comments">Загрузка комментариев...</div>';
            
            fetch(`/api/comments/${newsId}/`, {
                headers: {
                    'Accept': 'application/json' // Явно указываем, что ожидаем JSON
                }
            })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            console.error(`HTTP ошибка! Статус: ${response.status}`);
                            console.error("Содержимое ответа:", text);
                            throw new Error(`HTTP ошибка! Статус: ${response.status}`);
                        });
                    }
                    
                    // Проверка типа содержимого на валидность JSON
                    const contentType = response.headers.get("content-type");
                    if (!contentType || !contentType.includes("application/json")) {
                        return response.text().then(text => {
                            console.error("Неверный тип содержимого:", contentType);
                            console.error("Содержимое ответа:", text);
                            throw new Error(`Неожиданный тип содержимого: ${contentType}`);
                        });
                    }
                    
                    return response.json();
                })
                .then(data => {
                    console.log("Ответ от API комментариев:", data);
                    if (data.status === 'success') {
                        const comments = data.comments;
                        
                        if (comments.length === 0) {
                            commentsList.innerHTML = '<div class="no-comments">Комментариев пока нет. Будьте первым!</div>';
                        } else {
                            commentsList.innerHTML = '';
                            comments.forEach(comment => {
                                const commentItem = document.createElement('div');
                                commentItem.className = 'comment-item';
                                commentItem.innerHTML = `
                                    <div class="comment-header">
                                        <span class="comment-username">${comment.username}</span>
                                        <span class="comment-date">${comment.created_at}</span>
                                    </div>
                                    <div class="comment-text">${comment.text}</div>
                                `;
                                commentsList.appendChild(commentItem);
                            });
                        }
                    } else {
                        commentsList.innerHTML = `<div class="error-message">Ошибка загрузки комментариев: ${data.message}</div>`;
                    }
                })
                .catch(error => {
                    console.error('Ошибка при загрузке комментариев:', error);
                    commentsList.innerHTML = '<div class="error-message">Ошибка при загрузке комментариев. Пожалуйста, попробуйте позже.</div>';
                });
        }
        
        // Функция для добавления нового комментария
        function addComment(newsId, commentText) {
            if (!commentText.trim()) {
                commentError.textContent = 'Пожалуйста, введите текст комментария';
                commentError.style.display = 'block';
                return;
            }
            
            commentError.style.display = 'none';
            commentSubmit.disabled = true;
            
            fetch('/api/add-comment/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken(),
                    'Accept': 'application/json' // Явно указываем, что ожидаем JSON
                },
                body: JSON.stringify({
                    news_id: newsId,
                    comment_text: commentText
                })
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('Пожалуйста, войдите в систему, чтобы оставлять комментарии.');
                    }
                    
                    return response.text().then(text => {
                        console.error(`HTTP ошибка! Статус: ${response.status}`);
                        console.error("Содержимое ответа:", text);
                        throw new Error(`HTTP ошибка! Статус: ${response.status}`);
                    });
                }
                
                // Проверка типа содержимого на валидность JSON
                const contentType = response.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    return response.text().then(text => {
                        console.error("Неверный тип содержимого:", contentType);
                        console.error("Содержимое ответа:", text);
                        throw new Error(`Неожиданный тип содержимого: ${contentType}`);
                    });
                }
                
                return response.json();
            })
            .then(data => {
                console.log("Ответ от API добавления комментария:", data);
                if (data.status === 'success') {
                    // Очищаем форму
                    commentText.value = '';
                    
                    // Если это первый комментарий, очищаем сообщение "нет комментариев"
                    const noComments = commentsList.querySelector('.no-comments');
                    if (noComments) {
                        commentsList.innerHTML = '';
                    }
                    
                    // Добавляем новый комментарий в начало списка
                    const commentItem = document.createElement('div');
                    commentItem.className = 'comment-item';
                    commentItem.innerHTML = `
                        <div class="comment-header">
                            <span class="comment-username">${data.comment.username}</span>
                            <span class="comment-date">${data.comment.created_at}</span>
                        </div>
                        <div class="comment-text">${data.comment.text}</div>
                    `;
                    commentsList.insertBefore(commentItem, commentsList.firstChild);
                    
                    // Обновляем счетчик комментариев на кнопке
                    const commentButton = document.querySelector(`.comment-button[data-news-id="${newsId}"]`);
                    const countElement = commentButton.querySelector('.rating-count');
                    const currentCount = parseInt(countElement.textContent) || 0;
                    countElement.textContent = currentCount + 1;
                    
                } else {
                    commentError.textContent = data.message;
                    commentError.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Ошибка при добавлении комментария:', error);
                commentError.textContent = error.message;
                commentError.style.display = 'block';
            })
            .finally(() => {
                commentSubmit.disabled = false;
            });
        }
        
        // Обработчики для комментариев
        commentButtons.forEach(button => {
            button.addEventListener('click', () => {
                const newsId = button.dataset.newsId;
                currentNewsId = newsId;
                
                // Очищаем предыдущие данные
                commentText.value = '';
                commentError.style.display = 'none';
                
                // Проверяем авторизацию для формы комментариев
                if (userAuthenticated !== "true") {
                    commentForm.innerHTML = `
                        <div class="error-message">
                            Пожалуйста, <a href="${loginUrl}">войдите в систему</a>, чтобы оставлять комментарии.
                        </div>
                    `;
                } else {
                    // Восстанавливаем форму если она была изменена
                    if (!commentText) {
                        commentForm.innerHTML = `
                            <div class="error-message" id="comment-error" style="display: none;"></div>
                            <textarea class="comment-textarea" id="comment-text" placeholder="Напишите комментарий..."></textarea>
                            <button class="comment-submit" id="comment-submit">Отправить</button>
                        `;
                        commentText = document.getElementById('comment-text');
                        commentSubmit = document.getElementById('comment-submit');
                        commentError = document.getElementById('comment-error');
                    }
                }
                
                // Загружаем комментарии
                loadComments(newsId);
                
                // Открываем модальное окно
                commentsModal.style.display = 'block';
            });
        });
        
        // Обработчик для отправки комментария
        commentSubmit.addEventListener('click', () => {
            if (currentNewsId) {
                addComment(currentNewsId, commentText.value);
            }
        });
        
        // Обработчик для закрытия модального окна
        closeModal.addEventListener('click', () => {
            commentsModal.style.display = 'none';
        });
        
        // Закрытие модального окна при клике вне его области
        window.addEventListener('click', (event) => {
            if (event.target === commentsModal) {
                commentsModal.style.display = 'none';
            }
        });

        // Функция для получения CSRF токена
        function getCsrfToken() {
            return document.cookie
                .split('; ')
                .find(row => row.startsWith('csrftoken='))
                ?.split('=')[1];
        }
    });
</script>
{% endblock %}
