{% extends 'base.html' %}
{% load static %}

{% block title %}Экономические Новости - Главная{% endblock %}

{% block style %}
<style>
.main-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex: 1;
    overflow: hidden;
    width: 100%;
}

.news-content {
    background-color: white;
    padding: 20px;
    border-radius: 30px;
    width: calc(63% - 20px);
    flex: 1;
    overflow-y: auto;
    box-sizing: border-box;
    font-size: 1.5rem;
    margin-left: 20px;
    scrollbar-width: none;
    -ms-overflow-style: none;
    max-height: 65vh;
    position: relative;
}

.qr-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 15px;
    background-color: rgba(255, 255, 255, 0.5);
    border-radius: 8px;
    margin-top: 15px;
}

.qr-section img {
    width: 80%;
    height: auto;
}

.qr-section span {
    font-weight: bold;
    font-size: 2rem;
    color: white;
    margin-top: 10px;
}

.news-content h2 {
    font-size: 2.5rem;
    font-weight: bold;
}

.news-content p {
    font-size: 1.5rem;
    line-height: 1.6;
}

.news-item {
    margin-top: -20px;
    position: relative;
}

.news-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 20px;
}

.navigation-buttons {
    display: flex;
    gap: 10px;
}

.nav-button {
    background-color: #231c5c;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 8px 15px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background-color 0.3s, transform 0.2s;
}

.nav-button:hover {
    background-color: #1a1461;
    transform: translateY(-2px);
}

.nav-button:active {
    transform: translateY(0);
}

.timer-container {
    position: relative;
    width: 40px;
    height: 40px;
}

.timer-svg {
    transform: rotate(-90deg);
    width: 100%;
    height: 100%;
}

.timer-circle-bg {
    fill: none;
    stroke: #e6e6e6;
    stroke-width: 3.5;
}

.timer-circle-progress {
    fill: none;
    stroke: #231c5c;
    stroke-width: 3.5;
    stroke-linecap: round;
    stroke-dasharray: 125.6;
    stroke-dashoffset: 125.6;
    animation: countdown 20s linear forwards;
}

@keyframes countdown {
    from {
        stroke-dashoffset: 125.6;
    }
    to {
        stroke-dashoffset: 0;
    }
}

.timer-center {
    position: absolute;
    top: 5px;
    left: 5px;
    width: 30px;
    height: 30px;
    background-color: white;
    border-radius: 50%;
    z-index: 1;
}

.news-ratings {
    display: flex;
    align-items: center;
    gap: 15px;
}

.rating-button {
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    background: none;
    cursor: pointer;
    padding: 5px;
    transition: transform 0.2s, opacity 0.3s;
    opacity: 0.7;
    color: #231c5c;
}

.rating-button:hover {
    transform: scale(1.1);
    opacity: 1;
}

.rating-button.active {
    opacity: 1;
}

.like-button .rating-icon {
    width: 20px;
    height: 20px;
    display: inline-block;
    margin-right: 5px;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23231c5c"><path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-1.91l-.01-.01L23 10z"/></svg>');
}

.dislike-button .rating-icon {
    width: 20px;
    height: 20px;
    display: inline-block;
    margin-right: 5px;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23231c5c"><path d="M15 3H6c-.83 0-1.54.5-1.84 1.22l-3.02 7.05c-.09.23-.14.47-.14.73v1.91l.01.01L1 14c0 1.1.9 2 2 2h6.31l-.95 4.57-.03.32c0 .41.17.79.44 1.06L9.83 23l6.59-6.59c.36-.36.58-.86.58-1.41V5c0-1.1-.9-2-2-2zm4 0v12h4V3h-4z"/></svg>');
}

.comment-button .rating-icon {
    width: 20px;
    height: 20px;
    display: inline-block;
    margin-right: 5px;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23231c5c"><path d="M21.99 4c0-1.1-.89-2-1.99-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4-.01-18zM18 14H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>');
}

.like-button.active .rating-icon {
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%233949ab"><path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-1.91l-.01-.01L23 10z"/></svg>');
}

.dislike-button.active .rating-icon {
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%233949ab"><path d="M15 3H6c-.83 0-1.54.5-1.84 1.22l-3.02 7.05c-.09.23-.14.47-.14.73v1.91l.01.01L1 14c0 1.1.9 2 2 2h6.31l-.95 4.57-.03.32c0 .41.17.79.44 1.06L9.83 23l6.59-6.59c.36-.36.58-.86.58-1.41V5c0-1.1-.9-2-2-2zm4 0v12h4V3h-4z"/></svg>');
}

.rating-count {
    font-size: 0.9rem;
}

.background-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: -1;
    opacity: 0.5;
}

/* Стили для модального окна с комментариями */
.comments-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.5);
}

.comments-modal-content {
    position: relative;
    background-color: #fefefe;
    margin: 5% auto;
    padding: 20px;
    border-radius: 15px;
    width: 60%;
    max-width: 800px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    animation: modalopen 0.3s;
}

@keyframes modalopen {
    from {opacity: 0; transform: scale(0.9);}
    to {opacity: 1; transform: scale(1);}
}

.close-modal {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    transition: color 0.3s;
}

.close-modal:hover,
.close-modal:focus {
    color: #231c5c;
    text-decoration: none;
}

.comments-header {
    border-bottom: 1px solid #ddd;
    padding-bottom: 10px;
    margin-bottom: 15px;
}

.comments-header h3 {
    margin: 0;
    font-size: 1.5rem;
    color: #231c5c;
}

.comments-list {
    max-height: 400px;
    overflow-y: auto;
    margin-bottom: 20px;
}

.comment-item {
    padding: 10px;
    border-bottom: 1px solid #eee;
}

.comment-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
}

.comment-username {
    font-weight: bold;
    color: #231c5c;
}

.comment-date {
    color: #777;
    font-size: 0.8rem;
}

.comment-text {
    margin-bottom: 5px;
}

.comment-form {
    display: flex;
    flex-direction: column;
}

.comment-textarea {
    width: 100%;
    min-height: 80px;
    padding: 10px;
    margin-bottom: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    resize: vertical;
    font-family: inherit;
}

.comment-submit {
    align-self: flex-end;
    background-color: #231c5c;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 8px 15px;
    cursor: pointer;
    transition: background-color 0.3s;
}

.comment-submit:hover {
    background-color: #3949ab;
}

.no-comments {
    text-align: center;
    color: #777;
    padding: 20px;
}

.error-message {
    color: #f44336;
    margin-bottom: 10px;
}
</style>
{% endblock %}

{% block content %}
<div class="main-content">
    <div class="news-content">
        {% for news in news_list %}
        <div class="news-item" data-index="{{ forloop.counter0 }}" data-id="{{ news.id }}">
            <h2>{{ news.title }}</h2>
            <p>{{ news.description }}</p>
            <div class="news-controls">
                <div class="news-ratings">
                    <button class="rating-button like-button {% if news.user_rating == 'like' %}active{% endif %}" data-news-id="{{ news.id }}" data-rating="like">
                        <span class="rating-icon"></span>
                        <span class="rating-count">{{ news.likes_count }}</span>
                    </button>
                    <button class="rating-button dislike-button {% if news.user_rating == 'dislike' %}active{% endif %}" data-news-id="{{ news.id }}" data-rating="dislike">
                        <span class="rating-icon"></span>
                        <span class="rating-count">{{ news.dislikes_count }}</span>
                    </button>
                    <button class="rating-button comment-button" data-news-id="{{ news.id }}">
                        <span class="rating-icon"></span>
                        <span class="rating-count">{{ news.comments_count }}</span>
                    </button>
                </div>
                <div class="navigation-buttons">
                    <button class="nav-button back-button" data-index="{{ forloop.counter0 }}">Назад</button>
                    <button class="nav-button skip-button" data-index="{{ forloop.counter0 }}">Пропустить</button>
                </div>
                <div class="timer-container">
                    <svg class="timer-svg" viewBox="0 0 44 44">
                        <circle class="timer-circle-bg" cx="22" cy="22" r="20"></circle>
                        <circle class="timer-circle-progress" cx="22" cy="22" r="20"></circle>
                    </svg>
                    <div class="timer-center"></div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    <div class="qr-section">
        <img src="{% static 'Ad/images/qr-placeholder.png' %}" alt="QR код">
        <span>ЦБ РФ</span>
    </div>
</div>

<!-- Модальное окно с комментариями -->
<div id="comments-modal" class="comments-modal">
    <div class="comments-modal-content">
        <span class="close-modal">&times;</span>
        <div class="comments-header">
            <h3>Комментарии</h3>
        </div>
        <div class="comments-list" id="comments-list">
            <!-- Сюда будут добавляться комментарии -->
            <div class="no-comments">
                Комментариев пока нет. Будьте первым!
            </div>
        </div>
        <div class="comment-form" id="comment-form">
            <div class="error-message" id="comment-error" style="display: none;"></div>
            <textarea class="comment-textarea" id="comment-text" placeholder="Напишите комментарий..."></textarea>
            <button class="comment-submit" id="comment-submit">Отправить</button>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const newsItems = document.querySelectorAll('.news-item');
        const skipButtons = document.querySelectorAll('.skip-button');
        const likeButtons = document.querySelectorAll('.like-button');
        const dislikeButtons = document.querySelectorAll('.dislike-button');
        const backButtons = document.querySelectorAll('.back-button');
        const commentButtons = document.querySelectorAll('.comment-button');
        const commentsModal = document.getElementById('comments-modal');
        const closeModal = document.querySelector('.close-modal');
        const commentsList = document.getElementById('comments-list');
        const commentForm = document.getElementById('comment-form');
        const commentText = document.getElementById('comment-text');
        const commentSubmit = document.getElementById('comment-submit');
        const commentError = document.getElementById('comment-error');
        
        // Переменные для хранения текущего ID новости в модальном окне
        let currentNewsId = null;
        
        // Получаем информацию об аутентификации пользователя из шаблона Django
        const userAuthenticated = "{{ user.is_authenticated|yesno:'true,false' }}";
        const loginUrl = "{% url 'login' %}";

        let currentNewsIndex = 0;
        let timer;

        function showNews(index) {
            // Убедимся, что индекс в допустимом диапазоне
            if (index < 0) {
                index = newsItems.length - 1;
            } else if (index >= newsItems.length) {
                index = 0;
            }
            currentNewsIndex = index;

            // Сбрасываем и перезапускаем таймер анимации
            const timerProgressCircles = document.querySelectorAll('.timer-circle-progress');
            timerProgressCircles.forEach(circle => {
                circle.style.animation = 'none';
                circle.offsetHeight;
                circle.style.animation = 'countdown 20s linear forwards';
            });

            // Скрываем все новости и показываем только текущую
            newsItems.forEach((item, i) => {
                item.style.display = (i === index) ? 'block' : 'none';
            });

            // Очищаем предыдущий таймер и устанавливаем новый
            clearTimeout(timer);
            timer = setTimeout(() => {
                showNews((currentNewsIndex + 1) % newsItems.length);
            }, 20000);
        }

        // Инициализация показа новостей
        if (newsItems.length > 0) {
            showNews(currentNewsIndex);
        }

        // Обработчики для кнопки "Назад"
        backButtons.forEach(button => {
            button.addEventListener('click', () => {
                showNews(currentNewsIndex - 1);

                // AJAX запрос для уведомления сервера
                fetch("/api/skip-news/", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCsrfToken(),
                    },
                });
            });
        });

        // Добавляем обработчики для кнопки "Пропустить"
        skipButtons.forEach(button => {
            button.addEventListener('click', () => {
                showNews(currentNewsIndex + 1);

                // AJAX запрос для уведомления сервера
                fetch("/api/skip-news/", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCsrfToken(),
                    },
                });
            });
        });

        // Обработчики событий для кнопок оценки
        function handleRatingClick(button, rating) {
            const newsId = button.dataset.newsId;
            const ratingType = button.dataset.rating;

            // AJAX запрос для отправки оценки
            fetch("/api/rate-news/", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken(),
                },
                body: JSON.stringify({
                    news_id: newsId,
                    rating_type: ratingType
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ошибка! Статус: ${response.status}`);
                }
                // Проверка типа содержимого на валидность JSON
                const contentType = response.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    throw new Error(`Неожиданный тип содержимого: ${contentType}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success' || data.status === 'removed') {
                    // Обновляем счетчики лайков и дизлайков
                    const newsItem = document.querySelector(`.news-item[data-id="${newsId}"]`);
                    const likeButton = newsItem.querySelector('.like-button');
                    const dislikeButton = newsItem.querySelector('.dislike-button');

                    likeButton.querySelector('.rating-count').textContent = data.likes;
                    dislikeButton.querySelector('.rating-count').textContent = data.dislikes;

                    // Обновляем активный класс кнопок
                    if (data.status === 'success') {
                        if (ratingType === 'like') {
                            likeButton.classList.add('active');
                            dislikeButton.classList.remove('active');
                        } else {
                            dislikeButton.classList.add('active');
                            likeButton.classList.remove('active');
                        }
                    } else {
                        // Если оценка была удалена
                        button.classList.remove('active');
                    }
                } else if (data.status === 'error') {
                    console.error('Ошибка:', data.message);
                    alert(`Ошибка при оценке новости: ${data.message}`);
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                alert('Произошла ошибка при отправке оценки. Пожалуйста, попробуйте еще раз.');
            });
        }

        // Функция для проверки авторизации и вызова соответствующего действия
        function handleRatingButtonClick(button, ratingType) {
            if (userAuthenticated === "true") {
                handleRatingClick(button, ratingType);
            } else {
                alert('Пожалуйста, войдите в систему, чтобы оценивать новости.');
                window.location.href = loginUrl;
            }
        }

        // Обработчик для кнопок лайков
        likeButtons.forEach(button => {
            button.addEventListener('click', () => handleRatingButtonClick(button, 'like'));
        });

        // Обработчик для кнопок дизлайков
        dislikeButtons.forEach(button => {
            button.addEventListener('click', () => handleRatingButtonClick(button, 'dislike'));
        });
        
        // Функция для загрузки комментариев к новости
        function loadComments(newsId) {
            commentsList.innerHTML = '<div class="no-comments">Загрузка комментариев...</div>';
            
            fetch(`/api/comments/${newsId}/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ошибка! Статус: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        const comments = data.comments;
                        
                        if (comments.length === 0) {
                            commentsList.innerHTML = '<div class="no-comments">Комментариев пока нет. Будьте первым!</div>';
                        } else {
                            commentsList.innerHTML = '';
                            comments.forEach(comment => {
                                const commentItem = document.createElement('div');
                                commentItem.className = 'comment-item';
                                commentItem.innerHTML = `
                                    <div class="comment-header">
                                        <span class="comment-username">${comment.username}</span>
                                        <span class="comment-date">${comment.created_at}</span>
                                    </div>
                                    <div class="comment-text">${comment.text}</div>
                                `;
                                commentsList.appendChild(commentItem);
                            });
                        }
                    } else {
                        commentsList.innerHTML = `<div class="error-message">Ошибка загрузки комментариев: ${data.message}</div>`;
                    }
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                    commentsList.innerHTML = '<div class="error-message">Ошибка при загрузке комментариев. Пожалуйста, попробуйте позже.</div>';
                });
        }
        
        // Функция для добавления нового комментария
        function addComment(newsId, commentText) {
            if (!commentText.trim()) {
                commentError.textContent = 'Пожалуйста, введите текст комментария';
                commentError.style.display = 'block';
                return;
            }
            
            commentError.style.display = 'none';
            commentSubmit.disabled = true;
            
            fetch('/api/add-comment/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken(),
                },
                body: JSON.stringify({
                    news_id: newsId,
                    comment_text: commentText
                })
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('Пожалуйста, войдите в систему, чтобы оставлять комментарии.');
                    }
                    throw new Error(`HTTP ошибка! Статус: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    // Очищаем форму
                    commentText.value = '';
                    
                    // Если это первый комментарий, очищаем сообщение "нет комментариев"
                    const noComments = commentsList.querySelector('.no-comments');
                    if (noComments) {
                        commentsList.innerHTML = '';
                    }
                    
                    // Добавляем новый комментарий в начало списка
                    const commentItem = document.createElement('div');
                    commentItem.className = 'comment-item';
                    commentItem.innerHTML = `
                        <div class="comment-header">
                            <span class="comment-username">${data.comment.username}</span>
                            <span class="comment-date">${data.comment.created_at}</span>
                        </div>
                        <div class="comment-text">${data.comment.text}</div>
                    `;
                    commentsList.insertBefore(commentItem, commentsList.firstChild);
                    
                    // Обновляем счетчик комментариев на кнопке
                    const commentButton = document.querySelector(`.comment-button[data-news-id="${newsId}"]`);
                    const countElement = commentButton.querySelector('.rating-count');
                    const currentCount = parseInt(countElement.textContent) || 0;
                    countElement.textContent = currentCount + 1;
                    
                } else {
                    commentError.textContent = data.message;
                    commentError.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                commentError.textContent = error.message;
                commentError.style.display = 'block';
            })
            .finally(() => {
                commentSubmit.disabled = false;
            });
        }
        
        // Обработчики для комментариев
        commentButtons.forEach(button => {
            button.addEventListener('click', () => {
                const newsId = button.dataset.newsId;
                currentNewsId = newsId;
                
                // Очищаем предыдущие данные
                commentText.value = '';
                commentError.style.display = 'none';
                
                // Проверяем авторизацию для формы комментариев
                if (userAuthenticated !== "true") {
                    commentForm.innerHTML = `
                        <div class="error-message">
                            Пожалуйста, <a href="${loginUrl}">войдите в систему</a>, чтобы оставлять комментарии.
                        </div>
                    `;
                } else {
                    // Восстанавливаем форму если она была изменена
                    if (!commentText) {
                        commentForm.innerHTML = `
                            <div class="error-message" id="comment-error" style="display: none;"></div>
                            <textarea class="comment-textarea" id="comment-text" placeholder="Напишите комментарий..."></textarea>
                            <button class="comment-submit" id="comment-submit">Отправить</button>
                        `;
                        commentText = document.getElementById('comment-text');
                        commentSubmit = document.getElementById('comment-submit');
                        commentError = document.getElementById('comment-error');
                    }
                }
                
                // Загружаем комментарии
                loadComments(newsId);
                
                // Открываем модальное окно
                commentsModal.style.display = 'block';
            });
        });
        
        // Обработчик для отправки комментария
        commentSubmit.addEventListener('click', () => {
            if (currentNewsId) {
                addComment(currentNewsId, commentText.value);
            }
        });
        
        // Обработчик для закрытия модального окна
        closeModal.addEventListener('click', () => {
            commentsModal.style.display = 'none';
        });
        
        // Закрытие модального окна при клике вне его области
        window.addEventListener('click', (event) => {
            if (event.target === commentsModal) {
                commentsModal.style.display = 'none';
            }
        });

        // Функция для получения CSRF токена
        function getCsrfToken() {
            return document.cookie
                .split('; ')
                .find(row => row.startsWith('csrftoken='))
                ?.split('=')[1];
        }
    });
</script>
{% endblock %}
